{{!< layout/default}}

{{#extend "css"}}
    <style>
        .select2-search{
            z-index: 9999 !important;
        }

        .sended {
            color: #2196F3;
        }

        .approved {
            color: #2196F3;
        }

        .beaten {
            color: #9E9E9E;
        }

        .draft {
            color: #9E9E9E;
        }

        .rejected {
            color: #F44336;
        }

        .topmenu {
            padding-left:10px;
            padding-right:10px;
            padding-top:20px;
            padding-bottom:20px;
        }

        .topmenu select {
            width:220px;
        }

        .btn-xs {
            padding:7px;
        }

        body {
            color:black;
        }

        #budget-table tbody { 
            cursor: pointer; 
        }

        #inCreation {
            animation: pulse1 2s infinite;
        }

        #inContinuation {
            animation: pulse3 2s infinite;
        }

        #sended {
            animation: pulse1 2s infinite;
        }

        .inputColorsPulse {
            animation: pulse2 2s infinite;
        }

        @keyframes pulse1 {
            0% {
                background-color: #2ecc71;
            }
            100% {
                background-color: #9E9E9E;
            }
        }

        @keyframes pulse2 {
            0% {
                color: #3498db;
            }
            100% {
                color: #7f8c8d;
            }
        }

        @keyframes pulse3 {
            0% {
                background-color: #3498db;
            }
            100% {
                background-color: #9E9E9E;
            }
        }

        @keyframes send {
            0% {
                margin-left: 10%;
            }
            100% {
                margin-left: 90%;
            }
        }

        
        
        #emailSend {
            top: 45%;
            position:relative;
        }
        
        .sendEmailAnimation {
            animation: send 2s infinite;
        }
    </style>
{{/extend}}
<div id="loadingEmail"></div>
<!--<div style="background-color:#fff; max-width:520px; font-size:11px;" id="hiddenHTML"></div>-->
<div class="topmenu">
    <div class="row">
        <div class="col-md-2 col-sm-4 col-xs-12">
            <button class="btn btn-primary" type="button" id="newBudget">
                <i class="fas fa-plus"></i>&nbsp;Nueva cotización
            </button>
        </div>
        <div class="col-md-2 col-sm-4 col-xs-12">
            <select id="budget-filter" name="state">
                <option value="all">TODAS LAS COTIZACIONES</option>
                <option value="draft">EN BORRADOR</option>
                <option value="sended">ENVIADOS</option>
                <option value="created">CREADOS</option>
                <option value="expirated">VENCIDOS</option>
                <option value="approved">APROBADOS</option>
                <option value="canceled">CANCELADOS</option>
                <option value="byMe">CREADAS POR MI</option>
            </select>
        </div>
        
    </div>
</div>

<div class="table-responsive">
    <table id="budget-table" class="table table-hover">
        <thead>
            <tr>
                <th style="display : none;" scope="col">dateOrder</th>
                <th scope="col">FECHA</th>
                <th scope="col">NÚMERO DE LA COTIZACIÓN</th>
                <th scope="col">NOMBRE DE REFERENCIA</th>
                <th scope="col">NOMBRE DEL CLIENTE</th>
                <th scope="col">ESTADO</th>
                <th scope="col">DIVISA</th>
                <th scope="col">MONTO VENTA</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table> 
</div>

<!-- Modal -->
<div class="modal fade" id="budgetModal" data-keyboard="false" data-backdrop="static" role="dialog" aria-labelledby="modal_title">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" id="modal_header">
                <h4 class="modal-title" id="modal_title"></h4>
                
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div id="modal_footer"></div>
        </div>
    </div>
</div>
    
   

{{#extend "js"}}
<script src="/public/base64js/agromilloralogo.js"></script>
<script>
let rowSelected
let rowDataSelected
let datatable
let layouts = []
let products = []
let serverTime = ''
let productsAddedToBudget = 0
let addingProductStatus = 0
let productSelectedObj = {}
let s2ValueToAdd = ''
let clientsArr = [] //Arreglo con todos los clientes
let clientsNavisionArr = [] //Arreglo con todos los clientes navision
let s2EnabledProducts = [] // select2 de productos habilitados (values)
let addingProductsArr = [] // arreglo de productos a añadir a la cotización
let advancePercent = 0 // porcentaje de avance
let selectedClientData
let selectedLayoutData
let amounts = {}
let firmObj = {}
let orderCount = 0
let productsInDraftUpdate
let productsInDraft
let draftBudgetDataVar

let originalBudgetDivisa // para saber los datos originales de una cotización en continuación

$(document).ready(function() {
    $('#budget-filter').select2();
    $('#budget-link').css('color', '#2196F3');

    datatable = $('#budget-table')
    .DataTable( {
        ordering: true,
        order: [[ 0, 'desc' ]],
        iDisplayLength: 25,
        oLanguage: {
            sSearch: 'buscar: '
        },
        columnDefs: [{
            targets: [0],
            visible: false
        }, {
            targets: [ 1,2,3,4,5,6,7 ],
            orderable: false
        }],
        responsive: true,
        columns: [
            { data: 'dateOrder' },
            { data: 'creationDate' },
            { data: 'number' },
            { data: 'reference' },
            { data: 'clientName' },
            { data: 'status' },
            { data: 'divisa' },
            { data: 'cost' }        
        ],
        initComplete: function (settings, json) {
            getBudgets()
        },
        rowCallback: function(row, data, index){
            if(data.status == 'BORRADOR') {
                $(row).find('td:eq(4)').css('color', '#7f8c8d')
            } else if(data.status == 'ENVIADO') {
                $(row).find('td:eq(4)').css('color', '#1abc9c')
            } else if(data.status == 'APROBADO') {
                $(row).find('td:eq(4)').css('color', '#3498db')
            } else if(data.status == 'ENVIANDO...') {
                $(row).find('td:eq(4)').css('color', '#34495e')
            } else if(data.status == 'CREADO') {
                $(row).find('td:eq(4)').css('color', '#f39c12')
            } else if(data.status == 'CANCELADO') {
                $(row).find('td:eq(4)').css('color', '#e74c3c')
            } else if(data.status == 'VENCIDO') {
                $(row).find('td:eq(4)').css('color', '#c0392b')
            } else if(data.status == 'RESERVADO') {
                $(row).find('td:eq(4)').css('color', '#16a085')
            }
        }
    });
    /*
    datatable.on( 'order.dt search.dt', function () {
        datatable.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1
            orderCount = i+1
            console.log(orderCount)
        })
    } ).draw();
    */

    $('#budget-table tbody').on('click', 'tr', function() {
        rowSelected = datatable.row($(this))
        rowDataSelected = datatable.row($(this)).data()
        
        if(rowDataSelected) {
            chargeModal()
        }
       
    });
});

$('#budget-filter').on('change', function() {
    console.log($(this).val())
 
    ajax({
        url: 'api/getBudgets',
        type: 'POST',
        data: {
            status: $(this).val()
        }
    }).then(res => {
        if (res.err) {
            toastr.warning(res.err)
            $('#loadingBudgets').empty()
            datatable.clear().draw();
        } else if(res.ok) {
            console.log(res.ok)
            let formatRes = res.ok.map(el=>{
                if(el.status == 'sended' || el.status == 'created' || el.status == 'approved' || el.status == 'reserved' || el.status == 'canceled' || el.status == 'expired') {
                    el.number = `COT${el.number}`
                } else if(el.status == 'draft') {
                    el.number = `BOR${el.number}`
                }
                
                let rowCostFormat
                if(el.layout.divisa == 'clp') {
                    rowCostFormat = number_format(parseInt(el.amounts.iva)+parseInt(el.amounts.subtotal)); //comma_format(parseFloat(el.amounts.iva)+parseFloat(el.amounts.subtotal))
                } else{ 
                    rowCostFormat = (parseFloat(el.amounts.iva)+parseFloat(el.amounts.subtotal)).toFixed(2)
                }

                el.dateOrder = dateOrder(el._id) // DD/MM/YYYY to YYYYMMDD
                el.reference = el.reference.toUpperCase()
                el.clientName = el.client.name.toUpperCase()
                el.cost = rowCostFormat
                el.status = formatStatusText(el.status)
                el.divisa = el.layout.divisa.toUpperCase()
                return el
            })
            
            datatable.clear();
            datatable.rows.add(formatRes).draw()
            $('#loadingBudgets').empty()
        }      
    })
})

const getBudgets = () => {
    ajax({
        url: 'api/budgets'
    }).then(res => {
        if (res.err) {
            toastr.warning(res.err)
            $('#loadingBudgets').empty()
        } else if(res.ok) {
            console.log(res.ok)
            let formatRes = res.ok.map(el=>{
                if(el.status == 'sended' || el.status == 'created' || el.status == 'approved' || el.status == 'reserved' || el.status == 'canceled' || el.status == 'expired') {
                    el.number = `COT${el.number}`
                } else if(el.status == 'draft') {
                    el.number = `BOR${el.number}`
                }
                
                let rowCostFormat
                if(el.layout.divisa == 'clp') {
                    rowCostFormat = number_format(parseInt(el.amounts.iva)+parseInt(el.amounts.subtotal)); //comma_format(parseFloat(el.amounts.iva)+parseFloat(el.amounts.subtotal))
                } else{ 
                    rowCostFormat = (parseFloat(el.amounts.iva)+parseFloat(el.amounts.subtotal)).toFixed(2)
                }

                el.dateOrder = dateOrder(el._id) // DD/MM/YYYY to YYYYMMDD
                el.reference = el.reference.toUpperCase()
                el.clientName = el.client.name.toUpperCase()
                el.cost = rowCostFormat
                el.status = formatStatusText(el.status)
                el.divisa = el.layout.divisa.toUpperCase()
                return el
            })

            datatable.rows.add(formatRes).draw()
            $('#loadingBudgets').empty()
        }      
    })
}

const formatStatusText = (status) => {
    if(status == 'draft') {
        return 'BORRADOR'
    } else if(status == 'sended') {
        return 'ENVIADO'
    }  else if(status == 'created') {
        return 'CREADO'
    } else if(status == 'approved') {
        return 'APROBADO'
    } else if(status == 'reserved') {
        return 'RESERVADO'
    } else if(status == 'canceled') {
        return 'CANCELADO'
    } else if(status == 'expired') {
        return 'VENCIDO'
    }
}

const dateOrder = (creationDate) => {
    let splitDate = moment(creationDate).format('YYYYMMDDHHmmss')
    return splitDate
}

const getBudget = (id) => {
    return new Promise(resolve=> {
        ajax({
            url: 'api/getBudget',
            type: 'POST',
            data: {
                budgetId:id
            }
        }).then(res=>{
            if(res.ok) {
                resolve({ok:res.ok})
            } else {
                resolve(null)
            }
        })
    })
}

const chargeModal = () => {
    //console.log(rowDataSelected)
    $('#budgetModal').modal('show');
    
    getBudget(rowDataSelected._id).then(res=> {
        if(res.ok) {
            console.log(res.ok)
            if(res.ok.status == 'draft') {
                originalBudgetDivisa = res.ok.layout.divisa
                draftBudget(res.ok)
            } else if(res.ok.status == 'sended' || res.ok.status == 'created' || res.ok.status == 'approved' || res.ok.status == 'reserved' || res.ok.status == 'canceled' || res.ok.status == 'expired') {
                sendedBudget(res.ok)
            }
        }else {
            toastr.danger('No se ha encontrado la cotización seleccionada.')
        }
    })
}

$('#newBudget').on('click', function(){
    if(cartData != null) {
        newBudget()
    } else {
        toastr.warning('Para crear una cotización, primero debes <b><a href="/stockAvailability">añadir productos disponibles</a></b>')
    }
    
})

const sendedBudget = (sendedBudgetData) => { // aprobada, enviada, creada, cancelada...
    let sendedStatus = ''
    let ifCreated = ''
    let orderNumber = ''
    
    console.log('VER STATUS', sendedBudgetData)
    if(sendedBudgetData.status == 'approved') {
        sendedStatus = '<span class="badge badge-secondary" style="background:#3498db;"> Aprobada </span>'
    } else if(sendedBudgetData.status == 'sended') {
        sendedStatus = '<span class="badge badge-secondary" style="background:#2ecc71;"> Enviada </span>'
    } else if(sendedBudgetData.status == 'created') {
        sendedStatus = '<span class="badge badge-secondary" style="background:#f39c12;"> Creada </span>'
        ifCreated = `
            <button id="sendCreatedInvoice" class="btn btn-primary btn-block" >
                <i class="fas fa-envelope"></i> Enviar
            </button>
        `
    } else if(sendedBudgetData.status == 'reserved') {
        sendedStatus = '<span class="badge badge-secondary" style="background:#16a085;"> Reservada </span>'
    } else if(sendedBudgetData.status == 'canceled') { // TENGO QUE CAMBIAR EL STATUS A CANCELED
        sendedStatus = '<span class="badge badge-secondary" style="background:#e74c3c;"> Cancelada </span>' 
    }

    $('.modal-content').css({
        'border-color': '#1abc9c'
    })

    if(sendedBudgetData.order) {
        orderNumber = `Número de orden: <b>${sendedBudgetData.order}</b>`
    }

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    $('#modal_title').html(`
        Cotización <b>N° ${sendedBudgetData.number} </b> ${sendedStatus}
    `)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo"></div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN ${sendedBudgetData.number}</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <p>Cliente:</p>
                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><h4>${sendedBudgetData.creationDate}</h4></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><h4>${moment(sendedBudgetData.expirationDate).format('DD/MM/YYYY')}</h4></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><h4>${sendedBudgetData.reference}</h4></td>
                        </tr>
                    </tbody>
                </table>
                ${orderNumber}
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 table-responsive">
                <table class="table table-hover">
                    <thead>
                        <th>PRODUCTO</th>
                        <th>FECHA DE ENTREGA</th>
                        <th>UNIDADES</th>
                        <th>PRECIO UNITARIO</th>
                        <th>PRECIO TOTAL</th>
                    </thead>
                    <tbody id="tableBudgetProductsTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="row">   
            <div class="col-md-6" id="checkingAccount"></div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div class="row">
            <div class="col-md-12">
                ${sendedBudgetData.layout.textInfo}
            </div>
        </div>

        <div id="firm"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-3">
                <button class="btn btn-secondary btn-block closeModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-3">
                ${ifCreated}
            </div>

            <div class="col-md-3">
                <div class="form-group">
                    <select id="budgetChangeStatus" class="custom-select">
                        <option selected value="" disabled>Cambiar estado</option>
                        <option value="reserved">Reservado</option>
                        <option value="canceled">Cancelado (rechazado)</option>
                    </select>
                </div>
            </div>

            <div class="col-md-3">
                <button class="btn btn-danger btn-block" id="exportToPdf">
                    <i class="fas fa-file-pdf"></i> Exportar a pdf
                </button>
            </div>

        </div>
        <br>
    `)

    $('#sendCreatedInvoice').on('click', function() {
        sendEmailLoading(sendedBudgetData, 1)
        //exportToPdf(sendedBudgetData, 'send')

        exportToPdf(sendedBudgetData, 'send').then(sendRes=> {
            console.log('SENDRES', sendRes)
            if(sendRes.ok) { 
                
                datatable
                .row( rowSelected )
                .remove()
                .draw()
                
                let rowCostFormat
                let formatRes = sendRes.ok

                formatRes.number = `COT${formatRes.number}`
                if(formatRes.layout.divisa == 'clp') {
                    rowCostFormat = number_format(parseInt(formatRes.amounts.iva)+parseInt(formatRes.amounts.subtotal))
                } else {
                    rowCostFormat = (parseFloat(formatRes.amounts.iva)+parseFloat(formatRes.amounts.subtotal)).toFixed(2)
                }
                formatRes.dateOrder = dateOrder(formatRes._id) // DD/MM/YYYY to YYYYMMDD
                formatRes.reference = formatRes.reference.toUpperCase()
                formatRes.clientName = formatRes.client.name.toUpperCase()
                formatRes.cost = rowCostFormat
                formatRes.status = formatStatusText(formatRes.status)
                formatRes.divisa = formatRes.layout.divisa.toUpperCase()
                
                let newBudgetAdded = datatable
                .row.add(formatRes)
                .draw()
                .node()
                
                $(newBudgetAdded).css( 'color', '#1abc9c' )
                setTimeout(() => {
                    $(newBudgetAdded).css( 'color', '#000000' )
                }, 5000)
                
                sendEmailLoading(null, 1) // finalizar envío
                $('#budgetModal').modal('hide')
            } else if(sendRes.err) {
                toastr.error(`No pudimos enviar la cotización con referencia <b>${sendedBudgetData.reference}</b> para el cliente <b>${sendedBudgetData.client.name}</b>.`)
                sendEmailLoading(null, 1) // finalizar envío
            }
        })
    })

    $('#exportToPdf').on('click', function() {
        exportToPdf(sendedBudgetData, 'view')
    })


    $('#budgetChangeStatus').on('change dblclick', function() { // cambiar estado de una cotización
        let thisStatus = $(this).val()
        let statusTranslate = ''

        if(thisStatus == 'reserved') {
            statusTranslate = 'reservado'
            console.log('reservado')

            swal({
                title: 'Ingrese orden de compra',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Ingresar',
                cancelButtonText: 'Cancelar',
                showLoaderOnConfirm: true,
                preConfirm: (orden) => {
                    if(orden.length != '') {
                        return new Promise(resolve=> {
                            resolve(orden)
                        })
                    }
                },
                allowOutsideClick: () => !swal.isLoading()
            }).then((result) => {
                if (result.value) {
                    console.log(result.value)
                    ajax({
                        url: '/api/changeBudgetStatus',
                        type: 'POST',
                        data: {
                            id: sendedBudgetData._id,
                            toStatus: thisStatus,
                            orden: result.value
                        }
                    }).then(res=>{
                        if(res.ok) {
                            toastr.success(`Modificada la cotización ${res.ok.number}`)
                            $('#budgetModal').modal('hide')

                            datatable
                            .row( rowSelected )
                            .remove()
                            .draw()
                            
                            let rowCostFormat
                            let formatRes = res.ok

                            formatRes.number = `COT${res.ok.number}`
                            if(formatRes.layout.divisa == 'clp') {
                                rowCostFormat = number_format(parseInt(formatRes.amounts.iva)+parseInt(formatRes.amounts.subtotal))
                            } else {
                                rowCostFormat = (parseFloat(formatRes.amounts.iva)+parseFloat(formatRes.amounts.subtotal)).toFixed(2)
                            }
                            formatRes.dateOrder = dateOrder(formatRes._id) // DD/MM/YYYY to YYYYMMDD
                            formatRes.reference = formatRes.reference.toUpperCase()
                            formatRes.clientName = formatRes.client.name.toUpperCase()
                            formatRes.cost = rowCostFormat
                            formatRes.status = formatStatusText(formatRes.status)
                            formatRes.divisa = formatRes.layout.divisa.toUpperCase()
                            
                            let newBudgetAdded = datatable
                            .row.add(formatRes)
                            .draw()
                            .node()
                            
                            $(newBudgetAdded).css( 'color', '#1abc9c' )
                            setTimeout(() => {
                                $(newBudgetAdded).css( 'color', '#000000' )
                            }, 5000)

                            $('#budgetModal').modal('hide')

                        } else if(res.err) {
                            toastr.error(res.err)
                        }
                    })
                } else {
                    swal({
                        type: 'error',
                        title: 'Debe ingresar un numero de orden',
                        text: 'El número de orden no puede estar vacío'
                    })
                }
            })
        } else if(thisStatus == 'canceled') {
            statusTranslate = 'cancelado'

            swal({
                title: '¿Estás seguro de cambiar el estado de esta cotización?',
                text: `El estado cambiará a ${statusTranslate}`,
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar estado',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if(result.value) {
                    ajax({
                        url: '/api/changeBudgetStatus',
                        type: 'POST',
                        data: {
                            id: sendedBudgetData._id,
                            toStatus: thisStatus
                        }
                    }).then(res=>{
                        if(res.ok) {
                            toastr.success(`Modificada la cotización ${res.ok.number}`)
                            $('#budgetModal').modal('hide')

                            datatable
                            .row( rowSelected )
                            .remove()
                            .draw()
                            
                            let rowCostFormat
                            let formatRes = res.ok

                            formatRes.number = `COT${res.ok.number}`
                            if(formatRes.layout.divisa == 'clp') {
                                rowCostFormat = number_format(parseInt(formatRes.amounts.iva)+parseInt(formatRes.amounts.subtotal))
                            } else {
                                rowCostFormat = (parseFloat(formatRes.amounts.iva)+parseFloat(formatRes.amounts.subtotal)).toFixed(2)
                            }
                            formatRes.dateOrder = dateOrder(formatRes._id) // DD/MM/YYYY to YYYYMMDD
                            formatRes.reference = formatRes.reference.toUpperCase()
                            formatRes.clientName = formatRes.client.name.toUpperCase()
                            formatRes.cost = rowCostFormat
                            formatRes.status = formatStatusText(formatRes.status)
                            formatRes.divisa = formatRes.layout.divisa.toUpperCase()
                            
                            let newBudgetAdded = datatable
                            .row.add(formatRes)
                            .draw()
                            .node()
                            
                            $(newBudgetAdded).css( 'color', '#1abc9c' )
                            setTimeout(() => {
                                $(newBudgetAdded).css( 'color', '#000000' )
                            }, 5000)

                            $('#budgetModal').modal('hide')

                        } else if(res.err) {
                            toastr.error(res.err)
                        }
                    })
                }
            })
        }
        
    })

    /*
        GENERAL INFO INIT
    */
    let generalInfoHTML = sendedBudgetData.layout.generalInfo.reduce((txt, el, i)=>{
        let elReturn = ''
        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
                <p>${el.key}: ${el.value}</p>
            `
        }

        return txt += elReturn
    }, '')

    $('#generalInfo').html(generalInfoHTML)
    /*
        GENERAL INFO END
    */
    
    /*
        CLIENT INFO INIT
    */
    $('#selectedClientInfo').html(`
    <br>
        <table class="table">
            <tbody>
                <tr>
                    <td><center>Rut</center></td>
                    <td><center><b>${rutFunc(sendedBudgetData.client.rut)}</b></center></td>
                </tr>
                <tr>
                    <td><center>Nombre</center></td>
                    <td><center><b>${sendedBudgetData.client.name}</b></center></td>
                </tr>
                <tr>
                    <td><center>Teléfono</center></td>
                    <td><center><b>${sendedBudgetData.client.phone}</b></center></td>
                </tr>
                <tr>
                    <td><center>Email</center></td>
                    <td><center><b>${sendedBudgetData.client.email}</b></center></td>
                </tr>
            </tbody>
        </table>
    `)
    /*
        CLIENT INFO END
    */
   
    /*
        BUDGET PRODUCTS INIT
    */
    let productsInBudget = sendedBudgetData.products.reduce((htmlTXT,el,i)=>{
        let formatTotalPrice
        if(sendedBudgetData.layout.divisa == 'clp') {
            formatTotalPrice = number_format(el.totalPrice)
        } else {
            formatTotalPrice = el.totalPrice
        }
        return htmlTXT += `
        <tr>
            <td>${el.product}</td>
            <td>${el.deliveryDate}</td>
            <td>${number_format(el.qty)}</td>
            <td>${el.unitPrice}</td>
            <td>${formatTotalPrice}</td>
        </tr>
        `
    }, '')

    $('#tableBudgetProductsTbody').html(productsInBudget)
    /*
        BUDGET PRODUCTS END
    */

    /*
        CHECKING ACCOUNT INIT
    */
    let checkingAccountHTML = sendedBudgetData.layout.checkingAccount.content.reduce((txt, el, i)=>{
        let elReturn = ''

        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
            <tr>
                <td><center>${el.key}</center></td>
                <td><center><b>${el.value}</b></center></td>
            </tr>
            `
        }

        return txt += elReturn
    }, '')

    $('#checkingAccount').html(`
    <div class="card bg-light">
        <div class="card-header"><center>${sendedBudgetData.layout.checkingAccount.title}</center></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        ${checkingAccountHTML}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `)
    /*
        CHECKING ACCOUNT END
    */
   
    /*
        FINAL CANCULATIONS INIT sendedBudgetData
    */
    let iva
    let amountTXT = ''
    let sendedBudgetAdvancePercent = sendedBudgetData.amounts.advancePercent
    let finalAdvance = (parseFloat(sendedBudgetData.amounts.subtotal) * sendedBudgetAdvancePercent) / 100
    let finalInDelivery = (parseFloat(sendedBudgetData.amounts.subtotal) * (100-sendedBudgetAdvancePercent) ) / 100
    let amountNew = (parseFloat(sendedBudgetData.amounts.subtotal) / ((19 / 100) + 1))
    let amountTax = sendedBudgetData.amounts.iva //parseFloat(sendedBudgetData.amounts.subtotal) - parseFloat(amountNew)

    let finalAdvanceFormat
    let finalInDeliveryFormat
    let ivaFormat
    let finalAmountFormat
    let totalAmountFormat // finalAmount+iva
    if(sendedBudgetData.layout.divisa == 'clp') {
        iva = parseInt(amountTax)
        amountTXT = 'CLP $'
        finalAdvanceFormat = number_format(finalAdvance)
        finalInDeliveryFormat = number_format(finalInDelivery)
        ivaFormat = number_format(iva)
        finalAmountFormat = number_format(sendedBudgetData.amounts.subtotal)
        totalAmountFormat = number_format(parseInt(sendedBudgetData.amounts.subtotal)+iva)
    } else if (sendedBudgetData.layout.divisa == 'usd') {
        iva = 0
        amountTXT = 'USD $'
        finalAdvanceFormat = finalAdvance
        finalInDeliveryFormat = finalInDelivery
        ivaFormat = iva
        finalAmountFormat = sendedBudgetData.amounts.subtotal
        totalAmountFormat = parseFloat(sendedBudgetData.amounts.subtotal)+iva
    } else if(sendedBudgetData.layout.divisa == 'eur') {
        iva = 0
        amountTXT = 'EUR €'
        finalAdvanceFormat = finalAdvance
        finalInDeliveryFormat = finalInDelivery
        ivaFormat = iva
        finalAmountFormat = sendedBudgetData.amounts.subtotal
        totalAmountFormat = parseFloat(sendedBudgetData.amounts.subtotal)+iva
    }
    $('#finalCalculations').html(`
        <h3><b>Condiciones comerciales, de pago y Facturación:</b></h3>
        <table class="table table-hover">
            <tbody>
                <tr>
                    <td><center>${sendedBudgetAdvancePercent}% de anticipo de reserva:</center></td>
                    <td><center><b>${amountTXT}${finalAdvanceFormat}</b></center></td>
                </tr>
                <tr>
                    <td><center>${100-sendedBudgetAdvancePercent}% Saldo, al momento del despacho de las plantas:</center></td>
                    <td><center><b>${amountTXT}${finalInDeliveryFormat}</b></center></td>
                </tr>
                <tr>
                    <td><center>Sub total:</center></td>
                    <td><center><b>${amountTXT}${finalAmountFormat}</b></center></td>
                </tr>
                <tr>
                    <td><center>IVA, se deberá cancelar documentado, al día 10 del mes siguiente de la fecha de despacho:</center></td>
                    <td><center><b>${amountTXT}${ivaFormat}</b></center></td>
                </tr>
                <tr>
                    <td><center><h3>Total a pagar:</h3></center></td>
                    <td><center><h3 style="color:#1abc9c;"><b>${amountTXT}${totalAmountFormat}</b></h3></center></td>
                </tr>
            </tbody>
        </table>
    `)
    
    /*
        FINAL CALCULATIONS END
    */

    /*
        FIRM INIT
    */
    chargeFirm(sendedBudgetData.user)
    /*
        FIRM END
    */
    
}

function zeroTo100(selectedPercent) {
    let counterHtml = ''

    _.range(0, 101).forEach((current, index, range) => {
        let selected = ''
        if(current == selectedPercent) {
            selected = 'selected'
        }
        counterHtml += `<option value="${current}" ${selected}>${current}%</option>`
    })

    return counterHtml
}

const draftBudget = (draftBudgetData) => {
    
    draftBudgetDataVar = draftBudgetData
    $('.modal-content').css({
        'border-color': '#3498db'
    })

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeBudgetModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    $('#modal_title').html(`
        Cotización <span id="inContinuation" class="badge badge-secondary">En continuación </span>
    `)
    /*
        MODIFICAR ESTOS PARÁMETROS DEPENDIENDO DE LOS DATOS RECIBIDOS EN draftBudgetData 
    */
    addingProductStatus = 0
    productsAddedToBudget = draftBudgetData.products.length // cantidad de productos añadidos a la cotización
     // 
    s2ValueToAdd = ''
    productSelectedObj = {}
    s2EnabledProducts = []
    addingProductsArr = draftBudgetData.products // productos añadidos a la cotización
    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-xs-12">
                Plantilla seleccionada <select id="selectLayout" name="layoutName"></select>
            </div>
            <div class="col-md-6 col-xs-12">
                <div id="selectedDivisa"></div>
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo">
                
            </div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-clients-tab" data-toggle="tab" href="#nav-clients" role="tab" aria-controls="nav-clients" aria-selected="true">Clientes</a>
                        <a class="nav-item nav-link" id="nav-navision-tab" data-toggle="tab" href="#nav-navision" role="tab" aria-controls="nav-navision" aria-selected="false">Clientes Navision</a>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-clients" role="tabpanel" aria-labelledby="nav-clients-tab">
                        <br>
                        <center><select id="selectClient" name="clientName"></select></center>
                    </div>
                    <div class="tab-pane fade" id="nav-navision" role="tabpanel" aria-labelledby="nav-navision-tab">
                        <br>
                        <center><select id="selectClientNavision" name="navisionClientName"><option></option></select></center>
                    </div>
                </div>

                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><span id="serverDate"></span></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><input id="expirationDate" type="text" value="" placeholder="Fecha de vencimiento de la cotización" class="form-control border-input"></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><input id="reference" type="text" value="" placeholder="Nombre de referencia" class="form-control border-input"></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>
        
        <hr>
        <br>
        <div id="budgetProductSelected"></div>
        <div id="budgetProductsTable"></div>
        <br>
        <div class="row">   
            <div class="col-md-6" id="checkingAccount">
            </div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div class="accordion" id="accordionText">
            <div class="card">
                <div class="card-header" id="headingText">
                <h5 class="mb-0">
                    <button id="importantInfoButton" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"></button>
                </h5>
                </div>
            </div>

            <div id="collapseOne" class="collapse" aria-labelledby="headingText" data-parent="#accordionText">
                <div class="card-body" id="importantInfo"></div>
            </div>

        </div>

        <div id="firm"></div>
        
        <div id="errorMessage"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-2">
                <button class="btn btn-secondary btn-block closeBudgetModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-2">
                <button class="btn btn-danger btn-block" id="deleteDraftBudget">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>

            <div class="col-md-4">
                <button class="btn btn-secondary btn-block" id="saveDraftBudget">
                    <i class="fas fa-save"></i> Guardar como borrador
                </button>
            </div>

            <div class="col-md-4">
                <button class="btn btn-primary btn-block" id="saveBudget">
                    <i class="fas fa-save"></i> Guardar cotización
                </button>
            </div>
        </div>
        <br>
    `)

    $('#deleteDraftBudget').on('click', function() {
        swal({
            title: '¿Seguro de eliminar el borrador?',
            text: 'No podrás revertir esta acción',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Si, eliminar',
            cancelButtonText: 'No, cancelar'
        }).then((result) => {
            if (result.value) {
                deleteDraftBudget(draftBudgetData._id).then(res=>{
                    if (res.ok) {
                        datatable
                        .row( rowSelected )
                        .remove()
                        .draw()
                        $('#budgetModal').modal('hide')
                        toastr.success(`Borrador ${draftBudgetData.number} eliminado correctamente`)
                    } else if(res.err) {
                        toastr.error(`El borrador ${draftBudgetData.number} no fue eliminado`)
                    }
                })
            }
        })
        
    })

    $('#saveBudget').on('click', function(){
        saveBudget('new', draftBudgetData._id)
    })

    $('#saveDraftBudget').on('click', function(){
        saveBudget('continueDraft', draftBudgetData._id)
    })

    $('#reference').val(draftBudgetData.reference)
    chargeFirm(draftBudgetData.user) // cargar la firma del usuario creador original de la cotización

    
    console.log('PRODUCTS',draftBudgetData.products)
    let justNumbersSelected = ''
    if(draftBudgetData.layout.divisa == 'clp') {
        justNumbersSelected = 'justNumbers'
    } else {
        justNumbersSelected = 'justNumbersFloat'
    }
    productsInDraft = draftBudgetData.products.reduce((txt,el,i)=>{
        return txt += `
            <tr id="toInvoiceRow-${i}">
                <td>${el.product}</td>
                <td>${el.deliveryDate}</td>
                <td class="qtyProductClass" id="qtyProduct-${i}">${number_format(el.qty)}</td>
                <td>
                    <div class="form-group">
                        <input value="${el.unitPrice}" min="0" id="toInvoiceProductPrice-${i}" class="form-control ${justNumbersSelected} productPrice" type="number" placeholder="Costo unitario">
                    </div>
                </td>
                <td>
                    <span class="productTotalPrice" id="toInvoiceProductTotalPrice-${i}">0</span>
                </td>
            </tr>
            `
    }, '')
    
    console.log(productsInDraft)
    $('#budgetProductsTable').html(`
        
        <div class="card bg-light">
            <div class="card-header">Productos de cotización <span id="draftActionButtonContainer"><button onclick="updateAction()" id="draftActionButton" class="btn btn-sm btn-dark"><i class="fas fa-retweet"></i> Actualizar </button></span></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12 table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <td>PRODUCTO</td>
                                    <td>FECHA DE ENTREGA</td>
                                    <td>CANTIDAD A COTIZAR</td>
                                    <td>PRECIO UNITARIO</td>
                                    <td>PRECIO TOTAL</td>
                                </tr>
                            </thead>
                            <tbody id="budgetProductsCart">
                                ${productsInDraft}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `)
    
    $('.productPrice').on('keyup change', function() { // se repite el evento
        console.log('TEST DE EVENTO!!')
        let productRow = $(this).attr('id')
        let rowToInvoice = [...$(`#toInvoiceRow-${productRow.split('-')[1]}`)[0].children]
        
        if($(this).val() < 0) {
            $(this).val(0)
        }
        setTimeout(() => {
            finalCalculationDraft(draftBudgetData)
        }, 300);
    })

    finalCalculationDraft(draftBudgetData)

    getLayouts(draftBudgetData.layout).then(res=>{ // draft
        if(res) {
            let s2layouts = res.reduce((arr, el, i)=>{
                return arr.concat({
                    id: i,
                    text: el.layoutName
                })
            }, [])

            console.log(s2layouts)
            $('#selectLayout').select2({
                width:'40%',
                data: s2layouts
            })

            $('#selectLayout').on('select2:select', function (e) {
                printLayout() // draft
            });

            getClients().then(clients=>{
                let s2clients = []
                s2clients[0] = { // plantilla original de la cotización en borrador
                    id: draftBudgetData.client.rut,
                    text: draftBudgetData.client.name +' (original)'
                }

                s2clients = clients.reduce((arr, el, i)=>{
                    return arr.concat({
                        id: el.rut,
                        text: el.name
                    })
                }, s2clients)

                $('#selectClient').select2({
                    width:'80%',
                    data: s2clients
                })

                $('#selectClient').on('select2:select', function (e) {
                    if($('#selectClient').select2('data')[0].text.indexOf('(original)') > -1) {
                        updateClientsHTML(draftBudgetData.client)
                    } else {
                        updateClientsHTML()
                    }
                });

                updateClientsHTML(draftBudgetData.client)
            })

            getClientsNavision().then(clients=>{
                let s2clients = clients.reduce((arr, el, i)=>{
                    return arr.concat({
                        id: el.No_,
                        text: el.Name
                    })
                }, [])

                $('#selectClientNavision').select2({
                    width:'80%',
                    data: s2clients,
                    placeholder: 'Seleccione un cliente'
                })

                $('#selectClientNavision').on('select2:select', function (e) {
                    updateClientsNavisionHTML()
                });


                //updateClientsNavisionHTML()
            })

            getProducts().then(products=>{
                let s2products = products.reduce((arr, el, i)=>{
                    s2EnabledProducts.push(`${i}-${el.type.toLowerCase()}`)
                    return arr.concat({
                        id: `${i}-${el.type.toLowerCase()}`,
                        text: $(el.name).text()
                    })
                }, [])

                $('#selectProductToAdd').select2({
                    width:'80%',
                    placeholder: 'Seleccione un producto',
                    data: s2products
                })
                
                $('#selectProductToAdd').on('select2:select', function (e) {
                    let selectProductVal = $('#selectProductToAdd').val()
                    if(selectProductVal != 'default') {
                        addingProductStatus = 1
                        
                        let formatProductType = selectProductVal.substring(selectProductVal.indexOf('-') + 1);
                        let productNameSelected = $('#selectProductToAdd').select2('data')[0].text.toLowerCase()
                        s2ValueToAdd = selectProductVal
                        productSelectedObj = products.filter(function(el) {
                            return $(el.name).text().toLowerCase() == productNameSelected && el.type.toLowerCase() == formatProductType
                        })[0]

                        $('#budgetProductSelected').html(`
                            <div class="row">  
                                <div class="col-md-12 table-responsive">
                                    <div style="background:#ecf0f1;">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <td>Producto</td>
                                                    <td>Precio c/u</td>
                                                    <td>Unidades</td>
                                                    <td>Fecha estimada de entrega</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><br><center>${productSelectedObj.type} <b>${$(productSelectedObj.name).text()}</b></center></td>
                                                    <td><br><center>$${productSelectedObj.price}</center></td>
                                                    <td><input id="budgetProductStock" type="number" value="1" placeholder="Unidades" class="inputColorsPulse form-control border-input justNumbers"></td>
                                                    <td><input id="budgetProductDateOfDelivery" type="text" value="" placeholder="Fecha de entrega" class="inputColorsPulse form-control border-input"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `)

                        $('.justNumbers').keyup(function (){
                            this.value = (this.value + '').replace(/[^0-9]/g, ''); 
                        });
                        
                        
                        getTime().then(time=>{
                            let currentServerTime = time
                            let formatCurrentServerTime = moment(time).format('DD/MM/YYYY')

                            $('#budgetProductDateOfDelivery').val(formatCurrentServerTime)
                            $('#budgetProductDateOfDelivery').daterangepicker({
                                "locale": {
                                    "format": "DD/MM/YYYY",
                                    "daysOfWeek": [
                                    "Dom",
                                    "Lun",
                                    "Mar",
                                    "Mie",
                                    "Jue",
                                    "Vie",
                                    "Sab"
                                    ],
                                    "monthNames": [
                                    "Enero",
                                    "Febrero",
                                    "Marzo",
                                    "Abril",
                                    "Mayo",
                                    "Junio",
                                    "Julio",
                                    "Agosto",
                                    "Septiembre",
                                    "Octubre",
                                    "Noviembre",
                                    "Diciembre"
                                    ],
                                    "firstDay": 1
                                },
                                drops: "up",
                                singleDatePicker: true,
                                showDropdowns: true,
                                minDate: formatCurrentServerTime
                            });
                        })
                        
                    } else {
                        $('#budgetProductSelected').empty()
                    }
                    
                });
            })
            
            /*
                FECHA DE COTIZACION EN BORRADOR 
            */

            $('#serverDate').text(draftBudgetData.creationDate)
            $('#expirationDate').val(moment(draftBudgetData.expirationDate).format('DD/MM/YYYY'))
            $('#expirationDate').daterangepicker({
                "locale": {
                    "format": "DD/MM/YYYY",
                    "daysOfWeek": [
                    "Dom",
                    "Lun",
                    "Mar",
                    "Mie",
                    "Jue",
                    "Vie",
                    "Sab"
                    ],
                    "monthNames": [
                    "Enero",
                    "Febrero",
                    "Marzo",
                    "Abril",
                    "Mayo",
                    "Junio",
                    "Julio",
                    "Agosto",
                    "Septiembre",
                    "Octubre",
                    "Noviembre",
                    "Diciembre"
                    ],
                    "firstDay": 1
                },
                drops: "up",
                singleDatePicker: true,
                showDropdowns: true,
                minDate: draftBudgetData.creationDate
            })
              
            printLayout()
        }
   })
}

function backAction () {
    $('#budgetProductsCart').html(productsInDraft)
    
    $('#inputSelectDivisa').val(originalBudgetDivisa)
    draftBudgetDataVar.layout.divisa = originalBudgetDivisa
    finalCalculationDraft(draftBudgetDataVar)    

    $('.productPrice').on('keyup change', function() { // se repite el evento
        console.log('TEST DE EVENTO!!')
        let productRow = $(this).attr('id')
        let rowToInvoice = [...$(`#toInvoiceRow-${productRow.split('-')[1]}`)[0].children]
        
        if($(this).val() < 0) {
            $(this).val(0)
        }

        
        setTimeout(() => {
            finalCalculationDraft(draftBudgetDataVar)
        }, 300);
    })


    $('#draftActionButtonContainer').html('<button onclick="updateAction()" id="draftActionButton" class="btn btn-sm btn-dark"><i class="fas fa-retweet"></i> Actualizar </button>')
}

function deleteDraftBudget(id) {
    return new Promise(resolve=> {
        ajax({
            url: 'api/deleteDraftBudget',
            type: 'DELETE',
            data: {
                id: id
            }
        }).then(res=>{
            if(res.ok) {
                resolve({ok: res.ok})
            } else if(res.err) {
                resolve({err: res.err})
            }
        })
    })
}

function updateAction() {
    if(cartData) {
        let justNumbersSelected = ''
        if(draftBudgetDataVar.layout.divisa == 'clp') {
            justNumbersSelected = 'justNumbers'
        } else {
            justNumbersSelected = 'justNumbersFloat'
        }
        productsInDraftUpdate = cartData.products.reduce((txt,el,i)=>{
            return txt += `
                <tr id="toInvoiceRow-${i}">
                    <td>${el.productName}</td>
                    <td>${el.deliveryDate}</td>
                    <td class="qtyProductClass" id="qtyProduct-${i}">${number_format(el.qty)}</td>
                    <td>
                        <div class="form-group">
                            <input value="0" min="0" id="toInvoiceProductPrice-${i}" class="form-control ${justNumbersSelected} productPrice" type="number" placeholder="Costo unitario">
                        </div>
                    </td>
                    <td>
                        <span class="productTotalPrice" id="toInvoiceProductTotalPrice-${i}">0</span>
                    </td>
                </tr>
                `
        }, '')

        $('#budgetProductsCart').html(productsInDraftUpdate)

        finalCalculationDraft(draftBudgetDataVar)

        $('.productPrice').on('keyup change', function() { // se repite el evento
            console.log('TEST DE EVENTO!!')
            let productRow = $(this).attr('id')
            let rowToInvoice = [...$(`#toInvoiceRow-${productRow.split('-')[1]}`)[0].children]
            
            if($(this).val() < 0) {
                $(this).val(0)
            }
            setTimeout(() => {
                finalCalculationDraft(draftBudgetDataVar)
            }, 300);
        })
        

        $('#draftActionButtonContainer').html('<button onclick="backAction()" id="draftActionButton" class="btn btn-sm btn-dark"><i class="fas fa-undo-alt"></i> Original </button>')
            
    } else {
        toastr.warning('Para actualizar los productos de la cotización debes <b><a href="/stockAvailability">añadir productos disponibles</a></b>')
    }
        
        
}

const newBudget = () => {
    $('#budgetModal').modal('show')

    $('.modal-content').css({
        'border-color': '#1abc9c'
    })

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeBudgetModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    addingProductStatus = 0
    productsAddedToBudget = 0
    s2ValueToAdd = ''
    productSelectedObj = {}
    s2EnabledProducts = []
    addingProductsArr = []
    
    $('#modal_title').html(`
        Cotización <span id="inCreation" class="badge badge-secondary">En creación </span>
    `)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-xs-12">
                Plantilla seleccionada <select id="selectLayout" name="layoutName"></select>
            </div>
            <div class="col-md-6 col-xs-12">
                <div id="selectedDivisa"></div>
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo">
                
            </div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-clients-tab" data-toggle="tab" href="#nav-clients" role="tab" aria-controls="nav-clients" aria-selected="true">Clientes</a>
                        <a class="nav-item nav-link" id="nav-navision-tab" data-toggle="tab" href="#nav-navision" role="tab" aria-controls="nav-navision" aria-selected="false">Clientes Navision</a>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-clients" role="tabpanel" aria-labelledby="nav-clients-tab">
                        <br>
                        <center><select id="selectClient" name="clientName"><option></option></select></center>
                    </div>
                    <div class="tab-pane fade" id="nav-navision" role="tabpanel" aria-labelledby="nav-navision-tab">
                        <br>
                        <center><select id="selectClientNavision" name="navisionClientName"><option></option></select></center>
                    </div>
                </div>

                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><span id="serverDate"></span></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><input id="expirationDate" type="text" value="" placeholder="Fecha de vencimiento de la cotización" class="form-control border-input"></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><input id="reference" type="text" value="" placeholder="Nombre de referencia" class="form-control border-input"></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-12 table-responsive">
                <table class="table">
                    <thead>
                        <th>PRODUCTO</th>
                        <th>FECHA DE ENTREGA</th>
                        <th>CANTIDAD A COTIZAR</th>
                        <th>PRECIO UNITARIO</th>
                        <th>PRECIO TOTAL</th>
                    </thead>
                    <tbody id="budgetProductsCart"></tbody>
                </table>
            </div>
        </div>
        <br>
        <div class="row">   
            <div class="col-md-6" id="checkingAccount">
            </div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div class="accordion" id="accordionText">
            <div class="card">
                <div class="card-header" id="headingText">
                <h5 class="mb-0">
                    <button id="importantInfoButton" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"></button>
                </h5>
                </div>
            </div>

            <div id="collapseOne" class="collapse" aria-labelledby="headingText" data-parent="#accordionText">
                <div class="card-body" id="importantInfo"></div>
            </div>

        </div>
        <br>
        <div id="firm"></div>
        
        <div id="errorMessage"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-3">
                <button class="btn btn-secondary btn-block closeBudgetModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-5">
                <button class="btn btn-secondary btn-block" id="saveDraftBudget" disabled>
                    <i class="fas fa-save"></i> Guardar como borrador
                </button>
            </div>

            <div class="col-md-4">
                <button class="btn btn-primary btn-block" id="saveBudget" disabled>
                    <i class="fas fa-save"></i> Guardar cotización
                </button>
            </div>
        </div>
        <br>
    `)
    /*
    $('#saveBudget').attr('disabled', true)
    $('#saveDraftBudget').attr('disabled', true)
    */
    $('#saveBudget').on('click', function(){
        saveBudget('new')
    })

    $('#saveDraftBudget').on('click', function(){
        saveBudget('draft')
    })

    setTimeout(() => {
        $('#reference').focus()
    }, 500);

    chargeFirm() // cargar la firma del usuario conectado
    
    getLayouts().then(res=>{
        if(res) {
            let s2layouts = res.reduce((arr, el, i)=>{
                return arr.concat({
                    id: i,
                    text: el.layoutName
                })
            }, [])

            $('#selectLayout').select2({
                width:'40%',
                data: s2layouts
            })

            $('#selectLayout').on('select2:select', function (e) {
                printLayout()
            });


            getClients().then(clients=>{
                let s2clients = clients.reduce((arr, el, i)=>{
                    return arr.concat({
                        id: el.rut,
                        text: el.name
                    })
                }, [])

                $('#selectClient').select2({
                    width:'80%',
                    data: s2clients,
                    placeholder: 'Seleccione un cliente'
                })

                $('#selectClient').on('select2:select', function (e) {
                    updateClientsHTML()
                });


                //updateClientsHTML()
            })

            getClientsNavision().then(clients=>{
                let s2clients = clients.reduce((arr, el, i)=>{
                    return arr.concat({
                        id: el.No_,
                        text: el.Name
                    })
                }, [])

                $('#selectClientNavision').select2({
                    width:'80%',
                    data: s2clients,
                    placeholder: 'Seleccione un cliente'
                })

                $('#selectClientNavision').on('select2:select', function (e) {
                    updateClientsNavisionHTML()
                });


                //updateClientsNavisionHTML()
            })
            
            getTime().then(time=>{
                let currentServerTime = time
                let formatCurrentServerTime = moment(time).format('DD/MM/YYYY') 
                let defaultExpirationDate = moment(currentServerTime).add(1,'month').format('DD/MM/YYYY')

                $('#serverDate').text(formatCurrentServerTime)
                $('#expirationDate').val(defaultExpirationDate)
                $('#expirationDate').daterangepicker({
                    "locale": {
                        "format": "DD/MM/YYYY",
                        "daysOfWeek": [
                        "Dom",
                        "Lun",
                        "Mar",
                        "Mie",
                        "Jue",
                        "Vie",
                        "Sab"
                        ],
                        "monthNames": [
                        "Enero",
                        "Febrero",
                        "Marzo",
                        "Abril",
                        "Mayo",
                        "Junio",
                        "Julio",
                        "Agosto",
                        "Septiembre",
                        "Octubre",
                        "Noviembre",
                        "Diciembre"
                        ],
                        "firstDay": 1
                    },
                    drops: "up",
                    singleDatePicker: true,
                    showDropdowns: true,
                    minDate: formatCurrentServerTime
                });

            })
              
            printLayout()
                 
            let justNumbersSelected = ''
            if(selectedLayoutData.divisa == 'clp') {
                justNumbersSelected = 'justNumbers'
            } else {
                justNumbersSelected = 'justNumbersFloat'
            }
    
            let budgetProductsCartHTML = cartData.products.reduce((txt, el, i) => {
                return txt += `
                    <tr id="toInvoiceRow-${i}">
                        <td>${el.productName}</td>
                        <td>${el.deliveryDate}</td>
                        <td class="qtyProductClass" id="qtyProduct-${i}">${number_format(el.qty)}</td>
                        <td>
                            <div class="form-group">
                                <input value="0" min="0" id="toInvoiceProductPrice-${i}" class="form-control ${justNumbersSelected} productPrice" type="number" placeholder="Costo unitario">
                            </div>
                        </td>
                        <td>
                            <span class="productTotalPrice" id="toInvoiceProductTotalPrice-${i}">0</span>
                        </td>
                    </tr>
                `
            }, '')

            $('#budgetProductsCart').html(budgetProductsCartHTML)

            $('.productPrice').on('keyup change', function() {
                console.log('TEST DE EVENTO!!')
                let productRow = $(this).attr('id')
                let rowToInvoice = [...$(`#toInvoiceRow-${productRow.split('-')[1]}`)[0].children]
                
                if($(this).val() < 0) {
                    $(this).val(0)
                }
                setTimeout(() => {
                    finalCalculation()
                }, 300);
            })
        }
   })
}

$('#budgetModal').on('click', '.closeBudgetModal', function(){
    swal({
        title: '¿Estás seguro de cerrar la cotización?',
        text: 'Recuerda que puedes guardar esta cotización como borrador.',
        type: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonClass: 'btn btn-danger',
        cancelButtonClass: 'btn btn-primary',
        buttonsStyling: false,
        confirmButtonText: 'Si, cerrar',
        cancelButtonText: 'No, cancelar',
    }).then((result) => {
        if (result.value) {
            console.log('close')
            $('#budgetModal').modal('hide')
        }
    })
})

$('#budgetModal').on('click', '.closeModal', function(){
    $('#budgetModal').modal('hide')       
})


function updateClientsHTML(originalClientData) { // originalClientData en caso que sea borrador

    let selectedClient = $('#selectClient').select2('data')[0].id
    //console.log('SELECTEDCLIENT',selectedClient)
    if(selectedClient) {
        if(originalClientData) {
            selectedClientData = originalClientData
        } else {
            selectedClientData = clientsArr.filter(el=> {
                return el.rut == selectedClient
            })[0]
        }
        
        $('#selectedClientInfo').html(`
        <br>
            <table class="table">
                <tbody>
                    <tr>
                        <td><center>Rut</center></td>
                        <td><center><b>${rutFunc(selectedClientData.rut)}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Nombre</center></td>
                        <td><center><b>${selectedClientData.name}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Teléfono</center></td>
                        <td><input type="text" id="withoutPhone" class="form-control border-input" value="${selectedClientData.phone}"></td>
                    </tr>
                    <tr>
                        <td><center>Email</center></td>
                        <td><input type="text" id="withoutEmail" class="form-control border-input" value="${selectedClientData.email}"></td>
                    </tr>
                </tbody>
            </table>
        `)
        $('#saveBudget').attr('disabled', false)
        $('#saveDraftBudget').attr('disabled', false)
    } else {
        $('#saveBudget').attr('disabled', true)
        $('#saveDraftBudget').attr('disabled', true)
    }
    
}


function updateClientsNavisionHTML() {

    let selectedClient = $('#selectClientNavision').select2('data')[0].id
    //console.log('SELECTEDCLIENT',selectedClient)
    if(selectedClient) {
        let selectedClientDataRough = clientsNavisionArr.filter(el=> { //recoger todo en bruto
            return el.No_ == selectedClient
        })[0]
        
        selectedClientData = {
            rut: selectedClientDataRough.No_,
            name: selectedClientDataRough.Name,
            phone: selectedClientDataRough['Phone No_'],
            email: selectedClientDataRough['E-Mail']
        }
        console.log(selectedClientData)

        let withoutEmail = ''
        let withoutPhone = ''

        if(selectedClientData.email == '') {
            withoutEmail = `<input id="withoutEmail" class="form-control border-input" type="text" placeholder="Debe ingresar un email">`
        } else {
            withoutEmail = `<input value="${selectedClientData.email}" id="withoutEmail" class="form-control border-input" type="text" placeholder="Debe ingresar un email">`
            //withoutEmail = `<center><b>${selectedClientData.email}</b></center>`
        }

        if(selectedClientData.phone == '') {
            withoutPhone = `<input id="withoutPhone" class="form-control border-input" type="text" placeholder="Debe ingresar un teléfono">`
        } else {
            withoutPhone = `<input value="${selectedClientData.phone}" id="withoutPhone" class="form-control border-input" type="text" placeholder="Debe ingresar un teléfono">`
           // withoutPhone = `<center><b>${selectedClientData.phone}</b></center>`
        }
        
        $('#selectedClientInfo').html(`
        <br>
            <table class="table">
                <tbody>
                    <tr>
                        <td><center>Rut</center></td>
                        <td><center><b>${rutFunc(selectedClientData.rut)}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Nombre</center></td>
                        <td><center><b>${selectedClientData.name}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Teléfono</center></td>
                        <td>${withoutPhone}</td>
                    </tr>
                    <tr>
                        <td><center>Email</center></td>
                        <td>${withoutEmail}</td>
                    </tr>
                </tbody>
            </table>
        `)
        $('#saveBudget').attr('disabled', false)
        $('#saveDraftBudget').attr('disabled', false)
    } else {
        $('#saveBudget').attr('disabled', true)
        $('#saveDraftBudget').attr('disabled', true)
    }

}

function saveBudget(type, continueDraftId) {
    let status = ''
    let budgetObj = {
        reference: $('#reference').val(),
        creationDate: $('#serverDate').text(),
        expirationDate: $('#expirationDate').val(),
        client: {
            rut: selectedClientData.rut,
            name: selectedClientData.name,
            phone: selectedClientData.phone,
            email: selectedClientData.email
        },
        layout: selectedLayoutData,
        amounts: amounts,
        products: addingProductsArr
    }

    let validateCounter = 0
    let errorMessage = ''
    if(type == 'draft') {
        status = 'draft'
    } else if(type == 'continueDraft') { // en caso de continuar una cotizacion en borrador
        status = 'draft'
        budgetObj.id = continueDraftId
    } else if(type == 'new') {
        status = 'new'
    }

    if (budgetObj.reference.length > 0) { // 1
        validateCounter++
        $('#reference').css({
            border: '1px solid #3498db'
        })
    } else {
        errorMessage += `<br> * Debe ingresar nombre de referencia.`
        $('#reference').css({
            border: '1px solid #e74c3c'
        })
    }

    if(status == 'draft') {
        if(budgetObj.reference.length > 0 && validateCounter > 0) {

            if(selectedClientData.rut && selectedClientData.name && $('#withoutPhone').val() != '' && isEmail(removeExtraSpaces($('#withoutEmail').val()))) { // 2
                selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
                selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())
                validateCounter++
                $('#selectedClientInfo').css({
                    border: '1px solid #3498db'
                })
            } else {
                let validateClient = 0 // debe llegar a 2
                
                /*
                console.log('CLIENTDATA', selectedClientData)
                if(selectedClientData.phone == '') {
                    selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
                }

                if(selectedClientData.email == '') {
                    selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())
                }
                console.log('CLIENTDATA2', selectedClientData)
                */

                selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
                selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())

                if(selectedClientData.phone == '') {
                    $('#withoutPhone').css({
                        border: '1px solid #e74c3c'
                    })
                } else {
                    validateClient++
                    $('#withoutPhone').css({
                        border: '1px solid #3498db'
                    })
                    
                }

                if(selectedClientData.email == '') {
                    $('#withoutEmail').css({
                        border: '1px solid #e74c3c'
                    })
                } else {
                    if(isEmail(selectedClientData.email)) {
                        validateClient++
                        $('#withoutEmail').css({
                            border: '1px solid #3498db'
                        })
                    } else {
                        $('#withoutEmail').css({
                            border: '1px solid #e74c3c'
                        })
                    }
                }
                
                console.log(selectedClientData)
                if(validateClient == 2) {
                    validateCounter++
                    $('#selectedClientInfo').css({
                        border: '1px solid #3498db'
                    })
                    
                } else {
                    errorMessage += `<br> * Debe seleccionar un cliente.`

                    $('#selectedClientInfo').css({
                        border: '1px solid #e74c3c'
                    })
                }

                
            }

            $('#saveBudget').attr('disabled', true)
            $('#saveDraftBudget').attr('disabled', true)
            setTimeout(() => {
                if(validateCounter == 2) {
                    console.log('CORRECTO',selectedClientData)
                    
                    $('#saveBudget').attr('disabled', true)

                    budgetObj.client.rut = selectedClientData.rut
                    budgetObj.client.name = selectedClientData.name
                    budgetObj.client.phone = selectedClientData.phone
                    budgetObj.client.email = selectedClientData.email

                    saveDraftBudget(budgetObj)
                    
                    $('#errorMessage').empty()
                } else {
                    $('#errorMessage').html(`
                    <div class="alert alert-dismissible alert-warning">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                        <p class="mb-0">${errorMessage}</p>
                    </div> 
                    `)

                    $('#saveBudget').attr('disabled', false)
                    $('#saveDraftBudget').attr('disabled', false)
                }    
            }, 1000);

        } else {
            $('#errorMessage').html(`
            <div class="alert alert-dismissible alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                <p class="mb-0">${errorMessage}</p>
            </div> 
            `)
        }
    }
    
    if(status == 'new') {
        /*
        console.log('PRODUCTOS DE LA COTIZACION', addingProductsArr, cartData)
        if(addingProductsArr.length == cartData.products.length) { // 2
            validateCounter++
            budgetObj.products = addingProductsArr
            $('#selectProductToAddContainer').css({
                border: '1px solid #3498db'
            })
        } else {
            errorMessage += `<br> * Debe asignar un valor unitario a cada producto.`
            $('#selectProductToAddContainer').css({
                border: '1px solid #e74c3c'
            })
        }
        */

        if(selectedClientData.rut && selectedClientData.name && $('#withoutPhone').val() != '' && isEmail(removeExtraSpaces($('#withoutEmail').val()))) { // 2
            selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
            selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())
            validateCounter++
            $('#selectedClientInfo').css({
                border: '1px solid #3498db'
            })
        } else {
            let validateClient = 0 // debe llegar a 2
            /*
            console.log('CLIENTDATA', selectedClientData)
            if(selectedClientData.phone == '') {
                selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
            }

            if(selectedClientData.email == '') {
                selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())
            }

            
            console.log('CLIENTDATA2', selectedClientData)
            */
            selectedClientData.phone = removeExtraSpaces($('#withoutPhone').val())
            selectedClientData.email = removeExtraSpaces($('#withoutEmail').val())
            

            if(selectedClientData.phone == '') {
                $('#withoutPhone').css({
                    border: '1px solid #e74c3c'
                })
            } else {
                validateClient++
                $('#withoutPhone').css({
                    border: '1px solid #3498db'
                })
                
            }

            if(selectedClientData.email == '') {
                $('#withoutEmail').css({
                    border: '1px solid #e74c3c'
                })
            } else {
                if(isEmail(selectedClientData.email)) {
                    validateClient++
                    $('#withoutEmail').css({
                        border: '1px solid #3498db'
                    })
                } else {
                    $('#withoutEmail').css({
                        border: '1px solid #e74c3c'
                    })
                }
            }
            
            console.log(selectedClientData)
            if(validateClient == 2) {
                validateCounter++
                $('#selectedClientInfo').css({
                    border: '1px solid #3498db'
                })
                
            } else {
                errorMessage += `<br> * Debe seleccionar un cliente.`

                $('#selectedClientInfo').css({
                    border: '1px solid #e74c3c'
                })
            }

            
        }

        $('#saveBudget').attr('disabled', true)
        $('#saveDraftBudget').attr('disabled', true)
        setTimeout(() => {
            if(validateCounter == 2) {
                $('#saveBudget').attr('disabled', true)
                
                if(continueDraftId) { // en caso que se cree una nueva cotización desde un borrador
                    deleteDraftBudget(continueDraftId).then(res=>{
                        if (res.ok) {
                            datatable
                            .row( rowSelected )
                            .remove()
                            .draw()
                            //$('#budgetModal').modal('hide')
                            //toastr.success(`Borrador ${draftBudgetData.number} eliminado correctamente`)
                        } else if(res.err) {
                            //toastr.error(`El borrador ${draftBudgetData.number} no fue eliminado`)
                        }
                    })
                }

                budgetObj.client.rut = selectedClientData.rut
                budgetObj.client.name = selectedClientData.name
                budgetObj.client.phone = selectedClientData.phone
                budgetObj.client.email = selectedClientData.email
                saveNewBudget(budgetObj)
            } else {
                $('#errorMessage').html(`
                <div class="alert alert-dismissible alert-warning">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                    <p class="mb-0">${errorMessage}</p>
                </div> 
                `)

                $('#saveBudget').attr('disabled', false)
                $('#saveDraftBudget').attr('disabled', false)
            }    
        }, 1000);
        
    }
}

function saveNewBudget(budgetObj) {
    console.log(budgetObj)
    sendEmailLoading(budgetObj, 0)
    ajax({
        url: 'api/newBudget',
        type: 'POST',
        data: {
            reference: budgetObj.reference, // ok
            clientRut: budgetObj.client.rut, // ok
            clientName: budgetObj.client.name, // ok
            clientPhone: budgetObj.client.phone, // ok
            clientEmail: budgetObj.client.email, // ok
            userFirmName: firmObj.name, // ok
            userFirmLastname: firmObj.lastname, // ok
            userFirmPosition: firmObj.position, // ok
            userFirmPhone: firmObj.phone, // ok
            userFirmEmail: firmObj.email, // ok
            products: JSON.stringify(budgetObj.products), // ok
            layout: JSON.stringify(budgetObj.layout), // ok
            creationDate: budgetObj.creationDate, // ok
            expirationDate: budgetObj.expirationDate, // ok
            advancePercent: budgetObj.amounts.advancedPercent.toString(), // ok
            iva: budgetObj.amounts.iva.toString(), // ok
            subtotal: budgetObj.amounts.subtotal.toString() // ok
        }
    }).then(res=>{
        //console.log(res)
        if(res.ok) {
            let formatRes = Object.assign({}, res.ok) 
            toastr.success(`Se ha <b>creado</b> correctamente la cotización con referencia <b>${formatRes.reference}</b> para el cliente <b>${formatRes.client.name}</b>.`)

            if(formatRes.status == 'sended' || formatRes.status == 'created') {
                formatRes.number = `COT${formatRes.number}`
            } else if(formatRes.status == 'draft') {
                formatRes.number = `BOR${formatRes.number}`
            }

            formatRes.dateOrder = dateOrder(res.ok._id) // DD/MM/YYYY to YYYYMMDD
            formatRes.reference = res.ok.reference.toUpperCase()
            formatRes.clientName = res.ok.client.name.toUpperCase()
            if(res.ok.layout.divisa == 'clp') {
                formatRes.cost = number_format(parseInt(res.ok.amounts.iva)+parseInt(res.ok.amounts.subtotal))    
            } else {
                formatRes.cost = (parseFloat(res.ok.amounts.iva)+parseFloat(res.ok.amounts.subtotal)).toFixed(2)
            }
            formatRes.divisa = res.ok.layout.divisa.toUpperCase()
            formatRes.status = 'ENVIANDO...'/*formatStatusText(res.ok.status)*/
            
            let newBudgetAdded = datatable
            .row.add(formatRes)
            .draw()
            .node()
            
            $(newBudgetAdded).css( 'color', '#1abc9c' )
            setTimeout(() => {
                $(newBudgetAdded).css( 'color', '#000000' )
            }, 5000)
            $('#budgetModal').modal('hide')
            
            removeCart()

            sendEmailLoading(budgetObj, 1) // enviar correo loading
            exportToPdf(res.ok, 'send').then(exportRes=> {
                console.log(exportRes)
                if(exportRes.ok) { 
                let updateRow = datatable.row(newBudgetAdded)
                formatRes.status = 'ENVIADO'
                datatable
                .row( updateRow )
                .data( formatRes )
                .draw();
                
                $('#budgetModal').modal('hide')
                    toastr.success(`Se ha <b>enviado</b> correctamente la cotización con referencia <b>${formatRes.reference}</b> para el cliente <b>${formatRes.client.name}</b>.`)   
                    sendEmailLoading(null, 1) // finalizar envío
                } else if(exportRes.err) {

                    let updateRow = datatable.row(newBudgetAdded)
                    formatRes.status = 'CREADO'
                    datatable
                    .row( updateRow )
                    .data( formatRes )
                    .draw();
                    toastr.error(`No pudimos enviar la cotización con referencia <b>${formatRes.reference}</b> para el cliente <b>${formatRes.client.name}</b>.`)
                    sendEmailLoading(null, 1) // finalizar envío
                }
            })

        }
    })
}

function removeCart() {
    ajax({
        url: 'api/cleanCart'
    }).then(res=>{
        if(res.ok) {
            $('#cart').empty()
            cartData = null
        }
    })
}

function saveDraftBudget(budgetObj) {
    console.log(budgetObj)
   
    let continueDraftId = ''
    if(budgetObj.id) {
        continueDraftId = budgetObj.id
    }

    budgetObj.layout.layoutName = budgetObj.layout.layoutName.replace(' (original)','');

    ajax({
        url: 'api/draftBudget',
        type: 'POST',
        data: {
            id: continueDraftId,
            reference: budgetObj.reference, // ok
            clientRut: budgetObj.client.rut, // ok
            clientName: budgetObj.client.name, // ok
            clientPhone: budgetObj.client.phone, // ok
            clientEmail: budgetObj.client.email, // ok
            userFirmName: firmObj.name, // ok
            userFirmLastname: firmObj.lastname, // ok
            userFirmPosition: firmObj.position, // ok
            userFirmPhone: firmObj.phone, // ok
            userFirmEmail: firmObj.email, // ok
            products: JSON.stringify(budgetObj.products), // ok
            layout: JSON.stringify(budgetObj.layout), // ok
            creationDate: budgetObj.creationDate, // ok
            expirationDate: budgetObj.expirationDate, // ok
            advancePercent: budgetObj.amounts.advancedPercent.toString(), // ok
            iva: budgetObj.amounts.iva.toString(), // ok
            subtotal: budgetObj.amounts.subtotal.toString() // ok
        }
    }).then(res=>{
        if(res.ok) {
            let resText = ''
            if(res.ok.status == 'draft' && continueDraftId == '') {
                resText = `Se ha <b>creado</b> correctamente el <b>borrador</b> de cotización con referencia: <b>${res.ok.reference}</b> para el cliente <b>${res.ok.client.name}</b>.`
            } else if(res.ok.status == 'draft' && continueDraftId != '') {
                resText = `Se ha <b>modificado</b> correctamente el <b>borrador</b> de cotización con referencia: <b>${res.ok.reference}</b> para el cliente <b>${res.ok.client.name}</b>.`
                datatable
                .row( rowSelected )
                .remove()
                .draw()
            }

            toastr.success(resText)
            $('#budgetModal').modal('hide')
            
            let formatRes = res.ok 
            formatRes.number = `BOR${formatRes.number}`
            formatRes.dateOrder = dateOrder(res.ok._id) // DD/MM/YYYY to YYYYMMDD
            formatRes.reference = res.ok.reference.toUpperCase()
            formatRes.clientName = res.ok.client.name.toUpperCase()
            if(res.ok.layout.divisa == 'clp') {
                formatRes.cost = number_format(parseInt(res.ok.amounts.iva)+parseInt(res.ok.amounts.subtotal))    
            } else {
                formatRes.cost = (parseFloat(res.ok.amounts.iva)+parseFloat(res.ok.amounts.subtotal)).toFixed(2)
            }
            
            formatRes.divisa = res.ok.layout.divisa.toUpperCase()
            formatRes.status = formatStatusText(res.ok.status)

            let newBudgetAdded = datatable
            .row.add(formatRes)
            .draw()
            .node();
            
            $(newBudgetAdded).css( 'color', '#2980b9' )
            setTimeout(() => {
                $(newBudgetAdded).css( 'color', '#000000' )
            }, 5000);

        }
    })
    
}

function printLayout() {
    let selectedLayout = $('#selectLayout').select2('data')[0].text
    
    selectedLayoutData = layouts.filter(function(el) {
        return el.layoutName == selectedLayout
    })[0]

    advancePercent = selectedLayoutData.advancePercent

    if(selectedLayoutData.layoutName.indexOf('(original)') > -1) { // si es borrador
        finalCalculationDraft(draftBudgetDataVar)
    } else { // no es borrador
        finalCalculation()
    }
    
    console.log(advancePercent)
    let generalInfoHTML = selectedLayoutData.generalInfo.reduce((txt, el, i)=>{
        let elReturn = ''
        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
                <p>${el.key}: ${el.value}</p>
            `
        }

        return txt += elReturn
    }, '')
    

    $('#generalInfo').html(`${generalInfoHTML}`)

    $('#importantInfoButton').html(selectedLayoutData.textInfoTitle)
    $('#importantInfo').html(selectedLayoutData.textInfo)

    let checkingAccountHTML = selectedLayoutData.checkingAccount.content.reduce((txt, el, i)=>{
        let elReturn = ''

        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
            <tr>
                <td><center>${el.key}</center></td>
                <td><center><b>${el.value}</b></center></td>
            </tr>
            `
        }

        return txt += elReturn
    }, '')


    $('#checkingAccount').html(`
    <div class="card bg-light">
        <div class="card-header"><center>${selectedLayoutData.checkingAccount.title}</center></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        ${checkingAccountHTML}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `)
    
   console.log(selectedLayoutData)
}

function getLayouts(draftLayout) { // perfecto!
    
    return new Promise(resolve=>{
        ajax({
            url: 'api/layout/getAll'
        }).then(res=> {
            if(res.ok) {
                let resLayouts = res.ok.map(el=>{
                    delete el._id
                    delete el._rev
                    delete el.type

                    return el 
                })
                
                if(draftLayout) {
                    layouts = []
                    draftLayout.layoutName = draftLayout.layoutName + ' (original)'
                    layouts[0] = draftLayout
                    console.log(layouts)
                    layouts = resLayouts.reduce((arr, el, i) =>{
                        return arr.concat(el)
                    }, layouts)
                    
                    console.log(layouts)
                    resolve(layouts)
                } else {
                    layouts = resLayouts
                    resolve(resLayouts)
                }
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }
            
        })
    })
}

function getProducts() {
    return new Promise(resolve=>{
        ajax({
            url: 'api/product/getAll'
        }).then(res=> {
            if(res.ok) {
                products = res.ok

                resolve(res.ok)
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }     
        })
    })
}

function getClients() {
    return new Promise(resolve=> {
        ajax({
            url:'api/clientsEnabled'
        }).then(res=> {
            if(res.ok) {
                clientsArr = res.ok
                resolve(res.ok)
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }     
        })
    })
}

function getClientsNavision() {
    return new Promise(resolve=> {
        ajax({
            url:'api/clientsNavision'
        }).then(res=> {
            if(res.ok) {
                console.log(res)
                clientsNavisionArr = res.ok.list
                resolve(res.ok.list)
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }     
        })
    })
}

$('#modal_body').on('change', '#inputSelectDivisa', function() {
    if($(this).val() == 'clp') {
        selectedLayoutData.divisa = 'clp'
        $('.productPrice').each(function( i, el ) {
            $(`#toInvoiceProductPrice-${i}`).val(0)
        })

        addingProductsArr = []
    } else if($(this).val() == 'usd') { 
        selectedLayoutData.divisa = 'usd'
        $('.productPrice').each(function( i, el ) {
            $(`#toInvoiceProductPrice-${i}`).val(0)
        })

        addingProductsArr = []
    } else if($(this).val() == 'eur') {
        selectedLayoutData.divisa = 'eur'
        $('.productPrice').each(function( i, el ) {
            $(`#toInvoiceProductPrice-${i}`).val(0)
        })

        addingProductsArr = []
    }
    
    
    finalCalculation()
    
})

function finalCalculation(changePercent) {
    if(selectedLayoutData.divisa == 'clp') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp" selected>Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbersFloat')
        $('.productPrice').addClass('justNumbers')
       

        $('.qtyProductClass').each(function( i, el ) {
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${number_format(removePoints($(`#qtyProduct-${i}`).text()) * $(`#toInvoiceProductPrice-${i}`).val())}
            `)
            
        });

    } else if (selectedLayoutData.divisa == 'usd') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd" selected>Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbers')
        $('.productPrice').addClass('justNumbersFloat')
        
        $('.productPrice').each(function( i, el ) {
            //console.log($(`#qtyProduct-${i}`).text())
            
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${(removePoints($(`#qtyProduct-${i}`).text()) * $(el).val()).toFixed(2)}
            `)
            
        });

    } else if(selectedLayoutData.divisa == 'eur') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur" selected>Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbers')
        $('.productPrice').addClass('justNumbersFloat')

        $('.productPrice').each(function( i, el ) {
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${(removePoints($(`#qtyProduct-${i}`).text()) * $(el).val()).toFixed(2)}
            `)
        });
    }

    //console.log(amountNew, amountTax, iva)

    setTimeout(() => {
        let rowsToInvoice = [...$('#budgetProductsCart')[0].children]
        
        
        addingProductsArr = rowsToInvoice.reduce((arr, el, i)=> {
            let rowTotalPrice
            if(selectedLayoutData.divisa == 'clp') {
                rowTotalPrice = parseInt(removePoints(el.cells[4].innerText))
            } else {
                
                rowTotalPrice = parseFloat(el.cells[4].innerText)
                //console.log('PRICE', el.cells[4].innerText)
                //console.log('PRICECOMMAS:' , rowTotalPrice)
            }
            console.log('rowTotalPrice', rowTotalPrice)
            return arr.concat({
                product: el.cells[0].innerText,
                deliveryDate: el.cells[1].innerText,
                qty: removePoints(el.cells[2].innerText),
                unitPrice: $(`#toInvoiceProductPrice-${i}`).val(),
                totalPrice: rowTotalPrice
            })   
        }, [])
        console.log(addingProductsArr)

        let finalAmount = addingProductsArr.reduce((total, el, i)=>{
            return total += el.totalPrice
        },0)

        console.log(finalAmount)
        
        if(changePercent) {
            advancePercent = changePercent
        }
        
        let finalAdvance = (finalAmount * parseInt(advancePercent)) / 100
        let finalInDelivery = (finalAmount * (100-parseInt(advancePercent)) ) / 100

        let amountNew = (finalAmount / ((19 / 100) + 1))
        let amountTax = parseFloat(finalAmount) - parseFloat(amountNew)
        let iva
        let amountTXT = ''
        
        /*
            Valores a mostrar
        */
        let finalAdvanceFormat
        let finalInDeliveryFormat
        let ivaFormat
        let finalAmountFormat
        let totalAmountFormat // finalAmount+iva
        if(selectedLayoutData.divisa == 'clp') {
            iva = parseInt(amountTax)
            amountTXT = 'CLP $'
            finalAdvanceFormat = number_format(finalAdvance)
            finalInDeliveryFormat = number_format(finalInDelivery)
            ivaFormat = number_format(iva)
            finalAmountFormat = number_format(finalAmount)
            totalAmountFormat = number_format(finalAmount+iva)
        } else if(selectedLayoutData.divisa == 'usd') {
            iva = 0
            amountTXT = 'USD $'
            finalAdvanceFormat = finalAdvance.toFixed(2)
            finalInDeliveryFormat = finalInDelivery.toFixed(2)
            ivaFormat = iva
            finalAmountFormat = finalAmount.toFixed(2)
            totalAmountFormat = (finalAmount+iva).toFixed(2)
        } else if(selectedLayoutData.divisa == 'eur') {
            iva = 0
            amountTXT = 'EUR €'
            finalAdvanceFormat = finalAdvance.toFixed(2)
            finalInDeliveryFormat = finalInDelivery.toFixed(2)
            ivaFormat = iva
            finalAmountFormat = finalAmount.toFixed(2)
            totalAmountFormat = (finalAmount+iva).toFixed(2)
        }

        amounts.advancedPercent = parseInt(advancePercent)
        amounts.finalAdvance = finalAdvance
        amounts.iva = iva
        amounts.subtotal = finalAmount
        console.log(amounts)

        
        $('#finalCalculations').html(`
            <h3><b>Condiciones comerciales, de pago y Facturación:</b></h3>
            <table class="table table-hover">
                <tbody>
                    <tr>
                        <td><center> <select style="width:40px;" id="changePercentId">${zeroTo100(advancePercent)}</select> de anticipo de reserva:</center></td>
                        <td><center><b>${amountTXT}${finalAdvanceFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>${100-parseInt(advancePercent)}% Saldo, al momento del despacho de las plantas:</center></td>
                        <td><center><b>${amountTXT}${finalInDeliveryFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Sub total:</center></td>
                        <td><center><b>${amountTXT}${finalAmountFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>IVA, se deberá cancelar documentado, al día 10 del mes siguiente de la fecha de despacho:</center></td>
                        <td><center><b>${amountTXT}${ivaFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center><h3>Total a pagar:</h3></center></td>
                        <td><center><h3 style="color:#1abc9c;"><b>${amountTXT}${totalAmountFormat}</b></h3></center></td>
                    </tr>
                </tbody>
            </table>
        `)

        $('#changePercentId').on('change', function() {
            finalCalculation($(this).val())
        })
    }, 200);
    
}

function finalCalculationDraft(draftBudgetData, changePercent) {
    let divisaSelect = draftBudgetData.layout.divisa

    if(divisaSelect == 'clp') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp" selected>Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbersFloat')
        $('.productPrice').addClass('justNumbers')
       

        $('.qtyProductClass').each(function( i, el ) {
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${number_format(removePoints($(`#qtyProduct-${i}`).text()) * $(`#toInvoiceProductPrice-${i}`).val())}
            `)
            
        });

    } else if (divisaSelect == 'usd') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd" selected>Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbers')
        $('.productPrice').addClass('justNumbersFloat')
        
        $('.productPrice').each(function( i, el ) {
            //console.log($(`#qtyProduct-${i}`).text())
            
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${(removePoints($(`#qtyProduct-${i}`).text()) * $(el).val()).toFixed(2)}
            `)
            
        });

    } else if(divisaSelect == 'eur') {
        
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur" selected>Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
        

        $('.productPrice').removeClass('justNumbers')
        $('.productPrice').addClass('justNumbersFloat')

        $('.productPrice').each(function( i, el ) {
            $(`#toInvoiceProductTotalPrice-${i}`).html(`
                ${(removePoints($(`#qtyProduct-${i}`).text()) * $(el).val()).toFixed(2)}
            `)
        });
    }

    //console.log(amountNew, amountTax, iva)

    setTimeout(() => {
        let rowsToInvoice = [...$('#budgetProductsCart')[0].children]
        
        addingProductsArr = rowsToInvoice.reduce((arr, el, i)=> {
            let rowTotalPrice
            if(divisaSelect == 'clp') {
                rowTotalPrice = removePoints(el.cells[4].innerText)
            } else {
                
                rowTotalPrice = parseFloat(el.cells[4].innerText)
                console.log('PRICE', el.cells[4].innerText)
                console.log('PRICECOMMAS:' , rowTotalPrice)
            }
            console.log('rowTotalPrice', rowTotalPrice)
            return arr.concat({
                product: el.cells[0].innerText,
                deliveryDate: el.cells[1].innerText,
                qty: removePoints(el.cells[2].innerText),
                unitPrice: $(`#toInvoiceProductPrice-${i}`).val(),
                totalPrice: rowTotalPrice
            })   
        }, [])
        console.log(addingProductsArr)

        let finalAmount = addingProductsArr.reduce((total, el, i)=>{
            return total += el.totalPrice
        },0)

        console.log(finalAmount)
        
        if(changePercent) {
            advancePercent = changePercent
        }

        let finalAdvance = (finalAmount * parseInt(advancePercent)) / 100
        let finalInDelivery = (finalAmount * (100-parseInt(advancePercent)) ) / 100

        let amountNew = (finalAmount / ((19 / 100) + 1))
        let amountTax = parseFloat(finalAmount) - parseFloat(amountNew)
        let iva
        let amountTXT = ''
        
        /*
            Valores a mostrar
        */
        let finalAdvanceFormat
        let finalInDeliveryFormat
        let ivaFormat
        let finalAmountFormat
        let totalAmountFormat // finalAmount+iva
        if(divisaSelect == 'clp') {
            iva = parseInt(amountTax)
            amountTXT = 'CLP $'
            finalAdvanceFormat = number_format(finalAdvance)
            finalInDeliveryFormat = number_format(finalInDelivery)
            ivaFormat = number_format(iva)
            finalAmountFormat = number_format(finalAmount)
            totalAmountFormat = number_format(finalAmount+iva)
        } else if(divisaSelect == 'usd') {
            iva = 0
            amountTXT = 'USD $'
            finalAdvanceFormat = finalAdvance.toFixed(2)
            finalInDeliveryFormat = finalInDelivery.toFixed(2)
            ivaFormat = iva
            finalAmountFormat = finalAmount.toFixed(2)
            totalAmountFormat = (finalAmount+iva).toFixed(2)
        } else if(divisaSelect == 'eur') {
            iva = 0
            amountTXT = 'EUR €'
            finalAdvanceFormat = finalAdvance.toFixed(2)
            finalInDeliveryFormat = finalInDelivery.toFixed(2)
            ivaFormat = iva
            finalAmountFormat = finalAmount.toFixed(2)
            totalAmountFormat = (finalAmount+iva).toFixed(2)
        }

        amounts.advancedPercent = parseInt(advancePercent)
        amounts.finalAdvance = finalAdvance
        amounts.iva = iva
        amounts.subtotal = finalAmount
        console.log(amounts)

        
        $('#finalCalculations').html(`
            <h3><b>Condiciones comerciales, de pago y Facturación:</b></h3>
            <table class="table table-hover">
                <tbody>
                    <tr>
                        <td><center><select style="width:40px;" id="changePercentId">${zeroTo100(advancePercent)}</select> de anticipo de reserva:</center></td>
                        <td><center><b>${amountTXT}${finalAdvanceFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>${100-parseInt(advancePercent)}% Saldo, al momento del despacho de las plantas:</center></td>
                        <td><center><b>${amountTXT}${finalInDeliveryFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>Sub total:</center></td>
                        <td><center><b>${amountTXT}${finalAmountFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center>IVA, se deberá cancelar documentado, al día 10 del mes siguiente de la fecha de despacho:</center></td>
                        <td><center><b>${amountTXT}${ivaFormat}</b></center></td>
                    </tr>
                    <tr>
                        <td><center><h3>Total a pagar:</h3></center></td>
                        <td><center><h3 style="color:#1abc9c;"><b>${amountTXT}${totalAmountFormat}</b></h3></center></td>
                    </tr>
                </tbody>
            </table>
        `)

        $('#changePercentId').on('change', function() {
            finalCalculationDraft(draftBudgetData, $(this).val())
        })
    }, 200);
}

function chargeFirm(draftFirm) {
    if(draftFirm) {
        firmObj = {
            name: draftFirm.name,
            lastname: draftFirm.lastname,
            position: draftFirm.position,
            phone: draftFirm.phone,
            email: draftFirm.email
        }
        console.log(firmObj)

        $('#firm').html(`
            <center>
                <p style="font-family:Lucida Calligraphy; font-size:20px; color:#2ecc71; margin:1px">${capitalizeAll(firmObj.name)} ${capitalizeAll(firmObj.lastname)}.</p>
                <p style="font-family:Arial; margin:1px; font-size:18px;">AGROMILLORA SUR S.A.</p>
                <p style="margin:1px; font-size:18px;">${capitalizeAll(firmObj.position)}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.email}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.phone}</p>
            </center>
        `)
    } else {
        firmObj = {
            name: '{{credentials.name}}',
            lastname: '{{credentials.lastname}}',
            position: '{{credentials.position}}',
            phone: '{{credentials.phone}}',
            email: '{{credentials.email}}'
        }
        console.log(firmObj)

        $('#firm').html(`
            <center>
                <p style="font-family:Lucida Calligraphy; font-size:20px; color:#2ecc71; margin:1px">${capitalizeAll(firmObj.name)} ${capitalizeAll(firmObj.lastname)}.</p>
                <p style="font-family:Arial; margin:1px; font-size:18px;">AGROMILLORA SUR S.A.</p>
                <p style="margin:1px; font-size:18px;">${capitalizeAll(firmObj.position)}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.email}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.phone}</p>
            </center>
        `)
    }
}

function exportToPdf(budgetData, statusPDF) {
    console.log(budgetData)
    return new Promise(resolve=> {
        let doc = new jsPDF('p', 'pt', 'a4')
        /*
            x y w h
        */
        let ypos = 0 // altura en pixeles
        let rightYPos = 0
        let testdispose = 0

        doc.addImage(agromilloraLogoBase64, 'JPEG', 30, ypos+50, 200, 50)
        doc.setFontSize(9)
        //doc.setFontType('bold')
        //let generalBudgetInfo = 
        ypos+=30
        budgetData.layout.generalInfo.forEach(el => {
            ypos += 25
            doc.text(300, ypos, `${replaceAll(el.key, '<br>', '\n')}: ${replaceAll(el.value, '<br>', '\n')}`);
        })
        ypos += 50

        doc.setDrawColor(189, 195, 199)
        doc.setLineWidth(0.3)
        doc.line(30, ypos, 170, ypos)
        doc.setTextColor(52, 152, 219)
        doc.setFontSize(20)
        //doc.text(190, ypos+5, `COTIZACIÓN ${budgetData.number}`)
        doc.text(`COTIZACIÓN ${budgetData.number}`, 280, ypos+5, null, null, 'center');
        doc.setDrawColor(189, 195, 199)
        doc.line(400, ypos, 570, ypos)

        rightYPos = ypos

        ypos += 20
        doc.setTextColor(0, 0, 0)
        doc.setFontSize(9)
        doc.text(30, ypos, 'Cliente:')
        
        ypos += 25
        doc.setFontType('normal')
        doc.text(30, ypos, 'Nombre')
        doc.setFontType('bold')
        doc.text(80, ypos, `${replaceAll(budgetData.client.name, '<br>', '\n')}`)

        ypos += 25
        doc.setFontType('normal')
        doc.text(30, ypos, 'Rut')
        doc.setFontType('bold')
        doc.text(80, ypos, `${replaceAll(rutFunc(budgetData.client.rut), '<br>', '\n')}`)

        

        ypos += 25
        doc.setFontType('normal')
        doc.text(30, ypos, 'Teléfono')
        doc.setFontType('bold')
        doc.text(80, ypos, `${replaceAll(budgetData.client.phone, '<br>', '\n')}`)

        ypos += 25
        doc.setFontType('normal')
        doc.text(30, ypos, 'Email')
        doc.setFontType('bold')
        doc.text(80, ypos, `${replaceAll(budgetData.client.email, '<br>', '\n')}`)

        rightYPos += 60
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, 'Fecha de cotización')
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(400, rightYPos, budgetData.creationDate)

        rightYPos += 25
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, 'Fecha de vencimiento')
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(400, rightYPos, moment(budgetData.expirationDate).format('DD/MM/YYYY'))

        rightYPos += 25
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, 'Referencia')
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(400, rightYPos, replaceAll(budgetData.reference, '<br>', '\n'))

        let tableColumns = ['Producto', 'Fecha estimada de entrega', 'Unidades', 'Precio unitario', 'Monto'];

        var tableRows = budgetData.products.reduce((arr,el,i) => {
            let unitPriceFormat
            let totalPriceFormat
            if(budgetData.layout.divisa == 'clp') {
                unitPriceFormat = number_format(el.unitPrice)
                totalPriceFormat = number_format(el.totalPrice)
            } else {
                unitPriceFormat = el.unitPrice
                totalPriceFormat = el.totalPrice
            }

            return arr.concat([[
                `${el.product}`,
                el.deliveryDate,
                number_format(el.qty),
                `${unitPriceFormat}`,
                `${totalPriceFormat}`
            ]])
        }, []) 
        
        ypos += 30
        doc.autoTable(tableColumns, tableRows, {
            styles: {
                fontSize: 9
            },
            margin: {
                top: ypos
            }
        })

        ypos = doc.autoTable.previous.finalY + 30
        rightYPos = ypos

        doc.setFontSize(9)
        doc.setFontType('normal')
        doc.text(30, ypos, `${replaceAll(budgetData.layout.checkingAccount.title, '<br>', '\n')}`)

        ypos += 20

        doc.setFontSize(9)
        budgetData.layout.checkingAccount.content.forEach(el => {
            doc.setFontType('normal')
            doc.text(30, ypos, `${replaceAll(el.key, '<br>', '\n')}`);
            doc.setFontType('bold')
            doc.text(100, ypos, `${replaceAll(el.value, '<br>', '\n')}`);
            ypos += 25
        })

        doc.setFontType('bold')
        doc.setFontSize(9)

        doc.text(300, rightYPos, 'Condiciones comerciales, de pago y \nFacturación:');
        
        let finalAdvance = (budgetData.amounts.subtotal * budgetData.amounts.advancePercent) / 100
        let finalAdvance2 = (budgetData.amounts.subtotal * ((100-budgetData.amounts.advancePercent)) / 100)
        let amountNew = (parseFloat(budgetData.amounts.subtotal) / ((19 / 100) + 1))
        let amountTax = parseFloat(budgetData.amounts.subtotal) - parseFloat(amountNew)

        let amountTXT = ''
        iva = 0

        let finalAdvanceFormat
        let finalInDeliveryFormat
        let ivaFormat
        let finalAmountFormat
        let totalAmountFormat // finalAmount+iva
        if(budgetData.layout.divisa == 'clp') {
            iva = parseInt(amountTax)
            amountTXT = 'CLP $'

            finalAdvanceFormat = number_format(finalAdvance)
            finalInDeliveryFormat = number_format(finalAdvance2)
            ivaFormat = number_format(iva)
            finalAmountFormat = number_format(budgetData.amounts.subtotal)
            totalAmountFormat = number_format(parseInt(budgetData.amounts.subtotal)+iva)
        } else if (budgetData.layout.divisa == 'usd') {
            iva = 0
            amountTXT = 'USD $'

            finalAdvanceFormat = finalAdvance
            finalInDeliveryFormat = finalAdvance2
            ivaFormat = iva
            finalAmountFormat = budgetData.amounts.subtotal
            totalAmountFormat = parseInt(budgetData.amounts.subtotal)+iva
        } else if(budgetData.layout.divisa == 'eur') {
            iva = 0
            amountTXT = 'EUR €'

            finalAdvanceFormat = finalAdvance
            finalInDeliveryFormat = finalAdvance2
            ivaFormat = iva
            finalAmountFormat = budgetData.amounts.subtotal
            totalAmountFormat = parseInt(budgetData.amounts.subtotal)+iva
        }

        rightYPos += 40
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, `${budgetData.amounts.advancePercent}% de anticipo de reserva:`)
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(450, rightYPos, `${amountTXT} ${finalAdvanceFormat}`)

        rightYPos += 25
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, `${100-budgetData.amounts.advancePercent}% Saldo, al momento del\ndespacho de las plantas:`)
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(450, rightYPos, `${amountTXT} ${finalInDeliveryFormat}`)

        rightYPos += 35
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, `Subtotal:`)
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(450, rightYPos, `${amountTXT} ${finalAmountFormat}`)

        rightYPos += 25
        doc.setFontType('normal')
        doc.setFontSize(9)
        doc.text(300, rightYPos, `IVA, se deberá cancelar\ndocumentado, al día 10\ndel mes siguiente de la fecha\nde despacho:`)
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(450, rightYPos, `${amountTXT} ${ivaFormat}`)

        rightYPos += 60
        doc.setFontType('bold')
        doc.setFontSize(9)
        doc.text(300, rightYPos, `Total a pagar:`)
        doc.setFontType('bold')
        doc.setTextColor(42,200,138)
        doc.text(450, rightYPos, `${amountTXT} ${totalAmountFormat}`)
        
        let reformatHTML = budgetData.layout.textInfo

        ypos = 30
        
        let margins = {
            top: ypos,
            bottom: 40,
            left: 30,
            width: 550
        }

        let margins2 = {
            top: 10,
            bottom: 40,
            left: 30,
            width: 550
        }

        doc.addPage()
        doc.fromHTML(
            replaceAll(reformatHTML, '•', '*'), 
            margins.left, // x coord
            margins.top,
            {
                // y coord
                width: margins.width,// max width of content on PDF
            },function(dispose) {
                //ypos = dispose.y
                //console.log(dispose)
                doc.setTextColor(0, 0, 0)
                footerFormatting(doc, doc.internal.getNumberOfPages(), budgetData.user)
                if(statusPDF == 'send') {
                    let pdf = btoa(doc.output())
                    sendPdfToServer(pdf, budgetData).then(res=>{
                        resolve(res)
                    })
                } else if(statusPDF == 'view') {
                    doc.save(`cot-${budgetData.number}.pdf`);
                    resolve()
                }
            }, 
            margins2
        );

        
        function footerFormatting(doc, totalPages, user)
        {
            for(var i = totalPages; i >= 1; i--)
            {
                doc.setPage(i);                            
                //header
                //header(doc);
                
                footer(doc, i, totalPages, user);
                doc.page++;
            }
        };

        function footer(doc, pageNumber, totalPages, user){

            var str = "Página " + pageNumber + " de " + totalPages

            doc.setTextColor(0,0,0)
            doc.setFontType('normal')
            doc.setFontSize(9);
            doc.text(str, margins.left, doc.internal.pageSize.getHeight() - 20)
            if(pageNumber == totalPages) {
                doc.setFontSize(16);
                doc.setTextColor(42,200,138)
                doc.setFontType('italic')

                doc.text(`${capitalizeAll(user.name)} ${capitalizeAll(user.lastname)}`, 300, doc.internal.pageSize.getHeight() - 120, null, null, 'center');
            
                doc.setTextColor(0,0,0)
                doc.setFontType('normal')
                doc.setFontSize(14);

                doc.text(`AGROMILLORA SUR S.A.`, 300, doc.internal.pageSize.getHeight() - 100, null, null, 'center');
                doc.text(`${user.position}`, 300, doc.internal.pageSize.getHeight() - 80, null, null, 'center');
                doc.text(`${user.email}`, 300, doc.internal.pageSize.getHeight() - 60, null, null, 'center');
                doc.text(`${user.phone}`, 300, doc.internal.pageSize.getHeight() - 40, null, null, 'center');
                
                doc.setTextColor(0,0,0)
                doc.setFontType('normal')
                doc.setFontSize(9);
            }
        }   
    })
}


function sendPdfToServer(data, budgetData) {
    return new Promise(resolve=>{
        ajax({
            url: 'api/savePdf',
            type: 'POST',
            data: {
                pdf: data,
                budgetData: JSON.stringify(budgetData)
            }
        }).then(res=>{
            resolve(res)
        })
    })
}

function sendEmailLoading(budgetData, loadingStatus) {
    return new Promise(resolve=> {
        if(loadingStatus == 0) {
            $('#loadingEmail').html(`
                <div
                    style="  
                    width: 100%;
                    height: 100%;
                    background: rgba(236, 240, 241,0.8);
                    position: fixed;
                    left: 0;
                    top: 0;
                    z-index: 5000;">
                    
                    <div id="emailSend">

                        <center><h3>Creando cotización...</h3></center>
                        <center><i class="fa fa-circle-notch fa-spin fa-4x"></i></center>
                
                    </div>
                </div>
                `)
        } else if(loadingStatus == 1) {
            if(budgetData) {
                $('#loadingEmail').html(`
                <div
                    style="  
                    width: 100%;
                    height: 100%;
                    background: rgba(236, 240, 241,0.8);
                    position: fixed;
                    left: 0;
                    top: 0;
                    z-index: 5000;">
                    
                    <div id="emailSend">

                        <center><h3>Enviando cotización...</h3></center>
                        <div class="row">
                            <div class="col">
                                <center><img style="width:150px;" src="/public/img/agromillora.png" alt=""></center>
                            </div>
                            <div class="col">

                            </div>
                            <div class="col">
                                <center><h4>${budgetData.client.name}</h4></center>
                            </div>
                            
                        </div>
                    
                        <br>
                        <span class="sendEmailAnimation">
                            <i class="far fa-envelope fa-4x"></i>
                            <i style="color:rgba(231, 76, 60,1.0);" class="fas fa-file-pdf fa-1x"></i>
                        </span>
                
                    </div>
                </div>
                `)
            } else {
                $('#loadingEmail').empty()
            }

        }
    })
}

</script>
{{/extend}}
