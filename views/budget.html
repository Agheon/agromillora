{{!< layout/default}}

{{#extend "css"}}
    <style>
        .sended {
            color: #2196F3;
        }

        .approved {
            color: #2196F3;
        }

        .beaten {
            color: #9E9E9E;
        }

        .draft {
            color: #9E9E9E;
        }

        .rejected {
            color: #F44336;
        }

        .topmenu {
            padding-left:10px;
            padding-right:10px;
            padding-top:20px;
            padding-bottom:20px;
        }

        .topmenu select {
            width:220px;
        }

        .btn-xs {
            padding:7px;
        }

        body {
            color:black;
        }

        #budget-table tbody { 
            cursor: pointer; 
        }

        #inCreation {
            animation: pulse1 2s infinite;
        }

        #inContinuation {
            animation: pulse3 2s infinite;
        }

        #sended {
            animation: pulse1 2s infinite;
        }

        .inputColorsPulse {
            animation: pulse2 2s infinite;
        }

        @keyframes pulse1 {
            0% {
                background-color: #2ecc71;
            }
            100% {
                background-color: #9E9E9E;
            }
        }

        @keyframes pulse2 {
            0% {
                color: #3498db;
            }
            100% {
                color: #7f8c8d;
            }
        }

        @keyframes pulse3 {
            0% {
                background-color: #3498db;
            }
            100% {
                background-color: #9E9E9E;
            }
        }
    </style>
{{/extend}}
<div class="topmenu">
    <div class="row">
        <div class="col-md-2 col-sm-4 col-xs-12">
            <button class="btn btn-primary" type="button" id="newBudget">
                <i class="fas fa-plus"></i>&nbsp;Nueva cotización
            </button>
        </div>
        <div class="col-md-2 col-sm-4 col-xs-12">
            <select id="budget-filter" name="state">
                <option></option>
                <option value="sended">TODAS LAS COTIZACIONES</option>
                <option value="sended">EN BORRADOR</option>
                <option value="sended">ENVIADOS</option>
                <option value="beaten">VENCIDOS</option>
                <option value="approved">APROBADOS</option>
                <option value="rejected">RECHAZADOS</option>
            </select>
        </div>
        
    </div>
</div>

<table id="budget-table" class="table table-hover">
    <thead>
        <tr>
            <th style="display : none;" scope="col">dateOrder</th>
            <th scope="col">FECHA</th>
            <th scope="col">NÚMERO DE LA COTIZACIÓN</th>
            <th scope="col">NOMBRE DE REFERENCIA</th>
            <th scope="col">NOMBRE DEL CLIENTE</th>
            <th scope="col">ESTADO</th>
            <th scope="col">DIVISA</th>
            <th scope="col">COSTO</th>
        </tr>
    </thead>
    <tbody></tbody>
</table> 

<!-- Modal -->
<div class="modal fade" id="budgetModal" data-keyboard="false" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="modal_title">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" id="modal_header">
                <h4 class="modal-title" id="modal_title"></h4>
                
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div id="modal_footer"></div>
        </div>
    </div>
</div>
    
   

{{#extend "js"}}
<script>
let rowSelected
let rowDataSelected
let datatable
let layouts = []
let products = []
let serverTime = ''
let productsAddedToBudget = 0
let addingProductStatus = 0
let productSelectedObj = {}
let s2ValueToAdd = ''
let clientsArr = [] //Arreglo con todos los clientes
let s2EnabledProducts = [] // select2 de productos habilitados (values)
let addingProductsArr = [] // arreglo de productos a añadir a la cotización
let advancePercent = 0 // porcentaje de avance
let selectedClientData
let selectedLayoutData
let amounts = {}
let firmObj = {}
let orderCount = 0

$(document).ready(function() {
    $('#budget-filter').select2({
        placeholder: 'Filtrar por estado'
    });
    $('#budget-link').css('color', '#2196F3');

    datatable = $('#budget-table')
    .DataTable( {
        ordering: true,
        order: [[ 0, 'desc' ]],
        iDisplayLength: 100,
        oLanguage: {
            sSearch: 'buscar: '
        },
        columnDefs: [{
            targets: [0],
            visible: false
        }, {
            targets: [ 1,2,3,4,5,6,7 ],
            orderable: false
        }],
        responsive: false,
        columns: [
            { data: 'dateOrder' },
            { data: 'creationDate' },
            { data: 'number' },
            { data: 'reference' },
            { data: 'clientName' },
            { data: 'status' },
            { data: 'divisa' },
            { data: 'cost' }        
        ],
        initComplete: function (settings, json) {
            getBudgets()
        },
        rowCallback: function(row, data, index){
            if(data.status == 'BORRADOR') {
                $(row).find('td:eq(4)').css('color', '#2980b9')
            } else if(data.status == 'ENVIADO') {
                $(row).find('td:eq(4)').css('color', '#1abc9c')
            }
        }
    });
    /*
    datatable.on( 'order.dt search.dt', function () {
        datatable.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1
            orderCount = i+1
            console.log(orderCount)
        })
    } ).draw();
    */

    $('#budget-table tbody').on('click', 'tr', function() {
        rowSelected = datatable.row($(this))
        rowDataSelected = datatable.row($(this)).data()
        chargeModal()
    });
});


const getBudgets = () => {
    ajax({
        url: 'api/budgets'
    }).then(res => {
        if (res.err) {
            toastr.warning(res.err)
            $('#loadingBudgets').empty()
        } else if(res.ok) {
            console.log(res.ok)
            let formatRes = res.ok.map(el=>{
                //el.rut = `<b>${rutFunc(el.rut)}</b>`
                el.dateOrder = dateOrder(el._id) // DD/MM/YYYY to YYYYMMDD
                el.reference = el.reference.toUpperCase()
                el.clientName = el.client.name.toUpperCase()
                el.cost = comma_format(parseFloat(el.amounts.iva)+parseFloat(el.amounts.subtotal))
                el.status = formatStatusText(el.status)
                el.divisa = el.layout.divisa.toUpperCase()
                return el
            })

            datatable.rows.add(formatRes).draw()
            $('#loadingBudgets').empty()
        }      
    })
}

const formatStatusText = (status) => {
    if(status == 'draft') {
        return 'BORRADOR'
    } else if(status == 'sended') {
        return 'ENVIADO'
    }
}

const dateOrder = (creationDate) => {
    /*
    let splitDate = creationDate.split('/')
    splitDate = splitDate[2]+splitDate[1]+splitDate[0]
    */

    let splitDate = moment(creationDate).format('YYYYMMDDHHmmss')
    console.log(splitDate)
    return splitDate
}

const getBudget = (id) => {
    return new Promise(resolve=> {
        ajax({
            url: 'api/getBudget',
            type: 'POST',
            data: {
                budgetId:id
            }
        }).then(res=>{
            if(res.ok) {
                resolve({ok:res.ok})
            } else {
                resolve(null)
            }
        })
    })
}

const chargeModal = () => {
    //console.log(rowDataSelected)
    $('#budgetModal').modal('show');
    
    getBudget(rowDataSelected._id).then(res=> {
        if(res.ok) {
            console.log(res.ok)
            if(res.ok.status == 'draft') {
                draftBudget(res.ok)
            } else if(res.ok.status == 'sended') {
                sendedBudget(res.ok)
            }
        }else {
            toastr.danger('No se ha encontrado la cotización seleccionada.')
        }
    })
}

$('#newBudget').on('click', function(){
    newBudget()
})
const sendedBudget = (sendedBudgetData) => {
    $('.modal-content').css({
        'border-color': '#1abc9c'
    })

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    $('#modal_title').html(`
        Cotización <b>N° ${sendedBudgetData.number} </b><span class="badge badge-secondary" style="background:#2ecc71;"> Enviada </span>
    `)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo"></div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <p>Cliente:</p>
                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><h4>${sendedBudgetData.creationDate}</h4></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><h4>${sendedBudgetData.expirationDate}</h4></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><h4>${sendedBudgetData.reference}</h4></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <td>Producto</td>
                            <td>Precio c/u</td>
                            <td>Unidades</td>
                            <td>Monto</td>
                            <td>Fecha estimada de entrega</td>
                        </tr>
                    </thead>
                    <tbody id="tableBudgetProductsTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                ${sendedBudgetData.layout.textInfo}
            </div>
        </div>

        <div class="row">   
            <div class="col-md-6" id="checkingAccount"></div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div id="firm"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-3">
                <button class="btn btn-secondary btn-block closeModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-5"></div>

            <div class="col-md-4">
                <button class="btn btn-danger btn-block">
                    <i class="fas fa-file-pdf"></i> Exportar a pdf
                </button>
            </div>

        </div>
        <br>
    `)

    /*
        GENERAL INFO INIT
    */
    let generalInfoHTML = sendedBudgetData.layout.generalInfo.reduce((txt, el, i)=>{
        let elReturn = ''
        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
                <p>${el.key}: ${el.value}</p>
            `
        }

        return txt += elReturn
    }, '')

    $('#generalInfo').html(generalInfoHTML)
    /*
        GENERAL INFO END
    */
    
    /*
        CLIENT INFO INIT
    */
    $('#selectedClientInfo').html(`
    <br>
        <table class="table">
            <tbody>
                <tr>
                    <td><center>Rut</center></td>
                    <td><center><b>${rutFunc(sendedBudgetData.client.rut)}</b></center></td>
                </tr>
                <tr>
                    <td><center>Nombre</center></td>
                    <td><center><b>${sendedBudgetData.client.name}</b></center></td>
                </tr>
                <tr>
                    <td><center>Teléfono</center></td>
                    <td><center><b>${sendedBudgetData.client.phone}</b></center></td>
                </tr>
                <tr>
                    <td><center>Email</center></td>
                    <td><center><b>${sendedBudgetData.client.email}</b></center></td>
                </tr>
            </tbody>
        </table>
    `)
    /*
        CLIENT INFO END
    */
   
    /*
        BUDGET PRODUCTS INIT
    */
    let productsInBudget = sendedBudgetData.products.reduce((htmlTXT,el,i)=>{
        return htmlTXT += `
        <tr>
            <td><center>${el.type} ${el.name}</center></td>
            <td><center>$${el.price}</center></td>
            <td>${el.stock}</td>
            <td>$${comma_format(parseInt(el.price * el.stock))}</td>
            <td>${el.deliveryDate}</td>
        </tr>
        `
    }, '')

    $('#tableBudgetProductsTbody').html(productsInBudget)
    /*
        BUDGET PRODUCTS END
    */

    /*
        CHECKING ACCOUNT INIT
    */
    let checkingAccountHTML = sendedBudgetData.layout.checkingAccount.content.reduce((txt, el, i)=>{
        let elReturn = ''

        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
            <tr>
                <td><center>${el.key}</center></td>
                <td><center><b>${el.value}</b></center></td>
            </tr>
            `
        }

        return txt += elReturn
    }, '')

    $('#checkingAccount').html(`
    <div class="card bg-light">
        <div class="card-header"><center>${sendedBudgetData.layout.checkingAccount.title}</center></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        ${checkingAccountHTML}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `)
    /*
        CHECKING ACCOUNT END
    */
    
    /*
        FINAL CANCULATIONS INIT sendedBudgetData
    */
   
    let iva
    let amountTXT = ''
    let sendedBudgetAdvancePercent = sendedBudgetData.amounts.advancePercent
    let finalAdvance = (parseInt(sendedBudgetData.amounts.subtotal) * sendedBudgetAdvancePercent) / 100
    let finalInDelivery = (parseInt(sendedBudgetData.amounts.subtotal) * (100-sendedBudgetAdvancePercent) ) / 100
    let amountNew = (parseInt(sendedBudgetData.amounts.subtotal) / ((19 / 100) + 1))
    let amountTax = parseFloat(sendedBudgetData.amounts.subtotal) - parseFloat(amountNew)

    if(sendedBudgetData.layout.divisa == 'clp') {
        iva = parseInt(amountTax)
        amountTXT = 'CLP $'
    } else if (sendedBudgetData.layout.divisa == 'usd') {
        iva = 0
        amountTXT = 'USD $'
    } else if(sendedBudgetData.layout.divisa == 'eur') {
        iva = 0
        amountTXT = 'EUR €'
    }
    $('#finalCalculations').html(`
        <h3><b>Condiciones comerciales, de pago y Facturación:</b></h3>
        <table class="table table-hover">
            <tbody>
                <tr>
                    <td><center>${sendedBudgetAdvancePercent}% de anticipo de reserva:</center></td>
                    <td><center><b>${amountTXT}${comma_format(finalAdvance)}</b></center></td>
                </tr>
                <tr>
                    <td><center>${100-sendedBudgetAdvancePercent}% Saldo, al momento del despacho de las plantas:</center></td>
                    <td><center><b>${amountTXT}${comma_format(finalInDelivery)}</b></center></td>
                </tr>
                <tr>
                    <td><center>IVA, se deberá cancelar documentado, al día 10 del mes siguiente de la fecha de despacho:</center></td>
                    <td><center><b>${amountTXT}${comma_format(iva)}</b></center></td>
                </tr>
                <tr>
                    <td><center>Sub total:</center></td>
                    <td><center><b>${amountTXT}${comma_format(sendedBudgetData.amounts.subtotal)}</b></center></td>
                </tr>
                <tr>
                    <td><center><h3>Total a pagar:</h3></center></td>
                    <td><center><h3 style="color:#1abc9c;"><b>${amountTXT}${comma_format(parseInt(sendedBudgetData.amounts.subtotal)+iva)}</b></h3></center></td>
                </tr>
            </tbody>
        </table>
    `)
    /*
        FINAL CALCULATIONS END
    */

    /*
        FIRM INIT
    */
    chargeFirm(sendedBudgetData.user)
    /*
        FIRM END
    */
    
}

const draftBudget = (draftBudgetData) => {
    $('.modal-content').css({
        'border-color': '#3498db'
    })

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeBudgetModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    $('#modal_title').html(`
        Cotización <span id="inContinuation" class="badge badge-secondary">En continuación </span>
    `)
    /*
        MODIFICAR ESTOS PARÁMETROS DEPENDIENDO DE LOS DATOS RECIBIDOS EN draftBudgetData 
    */
    addingProductStatus = 0
    productsAddedToBudget = draftBudgetData.products.length // cantidad de productos añadidos a la cotización
     // 
    s2ValueToAdd = ''
    productSelectedObj = {}
    s2EnabledProducts = []
    addingProductsArr = draftBudgetData.products // productos añadidos a la cotización
    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-xs-12">
                Plantilla seleccionada <select id="selectLayout" name="layoutName"></select>
            </div>
            <div class="col-md-6 col-xs-12">
                <div id="selectedDivisa"></div>
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo">
                
            </div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <p>Cliente:</p>
                <center><select id="selectClient" name="clientName"></select></center>
                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><span id="serverDate"></span></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><input id="expirationDate" type="text" value="" placeholder="Fecha de vencimiento de la cotización" class="form-control border-input"></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><input id="reference" type="text" value="" placeholder="Nombre de referencia" class="form-control border-input"></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6" id="selectProductToAddContainer">     
                <center><select id="selectProductToAdd"><option value="default">Seleccione un producto</option></select></center>     
            </div>
            <div class="col-md-6">
                <button class="btn btn-dark btn-block" id="addProductToBudget">
                    <i style="color:#3498db;" class="fas fa-plus"></i> Añadir producto
                </button>
            </div>
        </div>
        <br>
        <div id="budgetProductSelected"></div>
        <div id="budgetProductsTable"></div>

        <div class="accordion" id="accordionText">
            <div class="card">
                <div class="card-header" id="headingText">
                <h5 class="mb-0">
                    <button id="importantInfoButton" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"></button>
                </h5>
                </div>
            </div>

            <div id="collapseOne" class="collapse" aria-labelledby="headingText" data-parent="#accordionText">
                <div class="card-body" id="importantInfo"></div>
            </div>

        </div>
        <br>
        <div class="row">   
            <div class="col-md-6" id="checkingAccount">
            </div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div id="firm"></div>
        
        <div id="errorMessage"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-3">
                <button class="btn btn-secondary btn-block closeBudgetModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-5">
                <button class="btn btn-secondary btn-block" id="saveDraftBudget">
                    <i class="fas fa-save"></i> Guardar como borrador
                </button>
            </div>

            <div class="col-md-4">
                <button class="btn btn-primary btn-block" id="saveBudget">
                    <i class="fas fa-save"></i> Guardar cotización
                </button>
            </div>
        </div>
        <br>
    `)

    $('#saveBudget').on('click', function(){
        saveBudget('new')
    })

    $('#saveDraftBudget').on('click', function(){
        saveBudget('continueDraft', draftBudgetData._id)
    })

    $('#reference').val(draftBudgetData.reference)
    chargeFirm(draftBudgetData.user) // cargar la firma del usuario creador original de la cotización

    if(draftBudgetData.products[0]) {
        let productsInDraft = draftBudgetData.products.reduce((htmlTXT,el,i)=>{
            return htmlTXT += `
            <tr id="row${el.type}">
                <td><center>${el.type} ${el.name}</center></td>
                <td><center>$${el.price}</center></td>
                <td>${el.stock}</td>
                <td>$${comma_format(parseInt(el.price * el.stock))}</td>
                <td>${el.deliveryDate}</td>
                <td><button onclick="removeBudgetProduct('${el.type}')" id="${el.type}" type="button" class="btn btn-danger btn-xs">x</button></td>
            </tr>
            `
        }, '')
        
        console.log(productsInDraft)
        $('#budgetProductsTable').html(`
            <div class="card bg-light">
                <div class="card-header">Productos de cotización</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <td>Producto</td>
                                        <td>Precio c/u</td>
                                        <td>Unidades</td>
                                        <td>Monto</td>
                                        <td>Fecha estimada de entrega</td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <tbody id="tableBudgetProductsTbody">
                                    ${productsInDraft}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `)
            
    }

    $('#addProductToBudget').on('click', function() {
        console.log('addingStatus: ' +addingProductStatus)
        console.log('counter: ' +productsAddedToBudget)
        if(addingProductStatus == 1 && $('#selectProductToAdd').val() != 'default') {
            if(productsAddedToBudget == 0) {
                productsAddedToBudget = 1 // contador de productos añadidos
                $('#budgetProductsTable').html(`
                <div class="card bg-light">
                    <div class="card-header">Productos de cotización</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <td>Producto</td>
                                            <td>Precio c/u</td>
                                            <td>Unidades</td>
                                            <td>Monto</td>
                                            <td>Fecha estimada de entrega</td>
                                            <td></td>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBudgetProductsTbody">
                                        <tr id="row${s2ValueToAdd}">
                                            <td><center>${productSelectedObj.type} ${$(productSelectedObj.name).text()}</center></td>
                                            <td><center>$${productSelectedObj.price}</center></td>
                                            <td>${$('#budgetProductStock').val()}</td>
                                            <td>$${comma_format(parseInt(productSelectedObj.price * $('#budgetProductStock').val()))}</td>
                                            <td>${$('#budgetProductDateOfDelivery').val()}</td>
                                            <td><button onclick="removeBudgetProduct('${s2ValueToAdd}')" id="${s2ValueToAdd}" type="button" class="btn btn-danger btn-xs">x</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                `)
            } else {
                productsAddedToBudget++
                $('#tableBudgetProductsTbody').append(`
                    <tr id="row${s2ValueToAdd}">
                        <td><center>${productSelectedObj.type} ${$(productSelectedObj.name).text()}</center></td>
                        <td><center>$${productSelectedObj.price}</center></td>
                        <td>${$('#budgetProductStock').val()}</td>
                        <td>$${comma_format(parseInt(productSelectedObj.price * $('#budgetProductStock').val()))}</td>
                        <td>${$('#budgetProductDateOfDelivery').val()}</td>
                        <td><button onclick="removeBudgetProduct('${s2ValueToAdd}')" id="${s2ValueToAdd}" type="button" class="btn btn-danger btn-xs">x</button></td>
                    </tr>
                `)
            }
            
            console.log(s2ValueToAdd)
            $(`#selectProductToAdd>option[value="${s2ValueToAdd}"]`).attr('disabled',true).change();
            $('#selectProductToAdd').select2({width:'80%'});

            s2EnabledProducts = s2EnabledProducts.filter(function(item) {
                return item !== s2ValueToAdd
            })
            
            addingProductsArr.push({
                name: $(productSelectedObj.name).text().toLowerCase(),
                type: productSelectedObj.type.toLowerCase(),
                price: parseInt(productSelectedObj.price),
                stock: parseInt($('#budgetProductStock').val()),
                deliveryDate: $('#budgetProductDateOfDelivery').val(),
                identifier: s2ValueToAdd
            })
            finalCalculation()
            console.log(addingProductsArr)

            if(s2EnabledProducts[0]) {
                $('#selectProductToAdd').val('default').trigger('change')
                $('#budgetProductSelected').empty()
            } else {
                $('#selectProductToAdd').val('default').trigger('change')
                $('#addProductToBudget').attr('disabled', true)
                $('#budgetProductSelected').empty()
            }
            
            addingProductStatus = 0
        } else {
            toastr.warning('Debe seleccionar un producto')
        }
    })

    getLayouts(draftBudgetData.layout).then(res=>{ // draft
        if(res) {
            let s2layouts = res.reduce((arr, el, i)=>{
                return arr.concat({
                    id: i,
                    text: el.layoutName
                })
            }, [])

            console.log(s2layouts)
            $('#selectLayout').select2({
                width:'40%',
                data: s2layouts
            })

            $('#selectLayout').on('select2:select', function (e) {
                printLayout() // draft
            });


            getClients().then(clients=>{
                let s2clients = [] 
                s2clients[0] = { // plantilla original de la cotización en borrador
                    id: draftBudgetData.client.rut,
                    text: draftBudgetData.client.name +' (original)'
                }
                s2clients = clients.reduce((arr, el, i)=>{
                    /*
                    let test = arr.filter(el=> {
                        return 
                    })
                    */

                    return arr.concat({
                        id: el.rut,
                        text: el.name
                    })
                }, s2clients)

                $('#selectClient').select2({
                    width:'80%',
                    data: s2clients
                })

                $('#selectClient').on('select2:select', function (e) {
                    updateClientsHTML()
                });


                updateClientsHTML()
            })

            getProducts().then(products=>{
                let s2products = products.reduce((arr, el, i)=>{
                    s2EnabledProducts.push(`${i}-${el.type.toLowerCase()}`)
                    return arr.concat({
                        id: `${i}-${el.type.toLowerCase()}`,
                        text: $(el.name).text()
                    })
                }, [])

                $('#selectProductToAdd').select2({
                    width:'80%',
                    placeholder: 'Seleccione un producto',
                    data: s2products
                })
                
                $('#selectProductToAdd').on('select2:select', function (e) {
                    let selectProductVal = $('#selectProductToAdd').val()
                    if(selectProductVal != 'default') {
                        addingProductStatus = 1
                        
                        let formatProductType = selectProductVal.substring(selectProductVal.indexOf('-') + 1);
                        let productNameSelected = $('#selectProductToAdd').select2('data')[0].text.toLowerCase()
                        s2ValueToAdd = selectProductVal
                        productSelectedObj = products.filter(function(el) {
                            return $(el.name).text().toLowerCase() == productNameSelected && el.type.toLowerCase() == formatProductType
                        })[0]

                        $('#budgetProductSelected').html(`
                            <div class="row">  
                                <div class="col-md-12 table-responsive">
                                    <div style="background:#ecf0f1;">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <td>Producto</td>
                                                    <td>Precio c/u</td>
                                                    <td>Unidades</td>
                                                    <td>Fecha estimada de entrega</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><br><center>${productSelectedObj.type} <b>${$(productSelectedObj.name).text()}</b></center></td>
                                                    <td><br><center>$${productSelectedObj.price}</center></td>
                                                    <td><input id="budgetProductStock" type="number" value="1" placeholder="Unidades" class="inputColorsPulse form-control border-input justNumbers"></td>
                                                    <td><input id="budgetProductDateOfDelivery" type="text" value="" placeholder="Fecha de entrega" class="inputColorsPulse form-control border-input"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `)

                        $('.justNumbers').keyup(function (){
                            this.value = (this.value + '').replace(/[^0-9]/g, ''); 
                        });
                        
                        
                        getTime().then(time=>{
                            let currentServerTime = time
                            let formatCurrentServerTime = moment(time).format('DD/MM/YYYY')

                            $('#budgetProductDateOfDelivery').val(formatCurrentServerTime)
                            $('#budgetProductDateOfDelivery').daterangepicker({
                                "locale": {
                                    "format": "DD/MM/YYYY",
                                    "daysOfWeek": [
                                    "Dom",
                                    "Lun",
                                    "Mar",
                                    "Mie",
                                    "Jue",
                                    "Vie",
                                    "Sab"
                                    ],
                                    "monthNames": [
                                    "Enero",
                                    "Febrero",
                                    "Marzo",
                                    "Abril",
                                    "Mayo",
                                    "Junio",
                                    "Julio",
                                    "Agosto",
                                    "Septiembre",
                                    "Octubre",
                                    "Noviembre",
                                    "Diciembre"
                                    ],
                                    "firstDay": 1
                                },
                                drops: "up",
                                singleDatePicker: true,
                                showDropdowns: true,
                                minDate: formatCurrentServerTime
                            });
                        })
                        
                    } else {
                        $('#budgetProductSelected').empty()
                    }
                    
                });
            })
            
            /*
                FECHA DE COTIZACION EN BORRADOR 
            */

            $('#serverDate').text(draftBudgetData.creationDate)
            $('#expirationDate').val(draftBudgetData.expirationDate)
            $('#expirationDate').daterangepicker({
                "locale": {
                    "format": "DD/MM/YYYY",
                    "daysOfWeek": [
                    "Dom",
                    "Lun",
                    "Mar",
                    "Mie",
                    "Jue",
                    "Vie",
                    "Sab"
                    ],
                    "monthNames": [
                    "Enero",
                    "Febrero",
                    "Marzo",
                    "Abril",
                    "Mayo",
                    "Junio",
                    "Julio",
                    "Agosto",
                    "Septiembre",
                    "Octubre",
                    "Noviembre",
                    "Diciembre"
                    ],
                    "firstDay": 1
                },
                drops: "up",
                singleDatePicker: true,
                showDropdowns: true,
                minDate: draftBudgetData.creationDate
            })
              
            printLayout()
        }
   })
}

const newBudget = () => {
    $('#budgetModal').modal('show')

    $('.modal-content').css({
        'border-color': '#1abc9c'
    })

    $('#closeModalButton').remove()
    $('#modal_header').append(`
        <button id="closeModalButton" type="button" class="close closeBudgetModal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `)

    addingProductStatus = 0
    productsAddedToBudget = 0
    s2ValueToAdd = ''
    productSelectedObj = {}
    s2EnabledProducts = []
    addingProductsArr = []
    
    $('#modal_title').html(`
        Cotización <span id="inCreation" class="badge badge-secondary">En creación </span>
    `)

    $('#modal_body').html(`
        <div class="row">
            <div class="col-md-6 col-xs-12">
                Plantilla seleccionada <select id="selectLayout" name="layoutName"></select>
            </div>
            <div class="col-md-6 col-xs-12">
                <div id="selectedDivisa"></div>
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6">
                <center> <img style="margin-top:50px;" src="/public/img/agromillora.png" alt=""> </center>
            </div>
            <div class="col-md-6" style="text-align:right" id="generalInfo">
                
            </div>
        </div>

        <div class="row">
            <div class="col-md-4"><hr></div>
            <div class="col-md-4" style="text-align:center;"><h3 style="color:#2196F3;">COTIZACIÓN</h3></div>
            <div class="col-md-4"><hr></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <p>Cliente:</p>
                <center><select id="selectClient" name="clientName"></select></center>
                <div id="selectedClientInfo"></div>
            </div>
            
            <div class="col-md-6">
                <table class="table table-hover">
                    <tbody>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de cotización</td>
                            <td><span id="serverDate"></span></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Fecha de vencimiento</td>
                            <td><input id="expirationDate" type="text" value="" placeholder="Fecha de vencimiento de la cotización" class="form-control border-input"></td>
                        </tr>
                        <tr>
                            <td style="background:#ecf0f1">Referencia</td>
                            <td><input id="reference" type="text" value="" placeholder="Nombre de referencia" class="form-control border-input"></td>
                        </tr>
                    </tbody>
                </table> 
            </div>
        </div>
        
        <hr>
        <div class="row">
            <div class="col-md-6" id="selectProductToAddContainer">     
                <center><select id="selectProductToAdd"><option value="default">Seleccione un producto</option></select></center>     
            </div>
            <div class="col-md-6">
                <button class="btn btn-dark btn-block" id="addProductToBudget">
                    <i style="color:#3498db;" class="fas fa-plus"></i> Añadir producto
                </button>
            </div>
        </div>
        <br>
        <div id="budgetProductSelected"></div>
        <div id="budgetProductsTable"></div>

        <div class="accordion" id="accordionText">
            <div class="card">
                <div class="card-header" id="headingText">
                <h5 class="mb-0">
                    <button id="importantInfoButton" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"></button>
                </h5>
                </div>
            </div>

            <div id="collapseOne" class="collapse" aria-labelledby="headingText" data-parent="#accordionText">
                <div class="card-body" id="importantInfo"></div>
            </div>

        </div>
        <br>
        <div class="row">   
            <div class="col-md-6" id="checkingAccount">
            </div>  
            <div class="col-md-6 table-responsive" id="finalCalculations"></div>
        </div>

        <div id="firm"></div>
        
        <div id="errorMessage"></div>
    `)

    $('#modal_footer').html(`
        <hr>
        
        <div class="row" style="margin-left:10px; margin-right:10px;">
            <div class="col-md-3">
                <button class="btn btn-secondary btn-block closeBudgetModal" >
                    <i style="color:#e74c3c;" class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <div class="col-md-5">
                <button class="btn btn-secondary btn-block" id="saveDraftBudget">
                    <i class="fas fa-save"></i> Guardar como borrador
                </button>
            </div>

            <div class="col-md-4">
                <button class="btn btn-primary btn-block" id="saveBudget">
                    <i class="fas fa-save"></i> Guardar cotización
                </button>
            </div>
        </div>
        <br>
    `)

    $('#saveBudget').on('click', function(){
        saveBudget('new')
    })

    $('#saveDraftBudget').on('click', function(){
        saveBudget('draft')
    })

    setTimeout(() => {
        $('#reference').focus()
    }, 500);

    chargeFirm() // cargar la firma del usuario conectado

    $('#addProductToBudget').on('click', function() {
        console.log('addingStatus: ' +addingProductStatus)
        console.log('counter: ' +productsAddedToBudget)
        if(addingProductStatus == 1 && $('#selectProductToAdd').val() != 'default') {
            if(productsAddedToBudget == 0) {
                productsAddedToBudget = 1 // contador de productos añadidos
                $('#budgetProductsTable').html(`
                <div class="card bg-light">
                    <div class="card-header">Productos de cotización</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <td>Producto</td>
                                            <td>Precio c/u</td>
                                            <td>Unidades</td>
                                            <td>Monto</td>
                                            <td>Fecha estimada de entrega</td>
                                            <td></td>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBudgetProductsTbody">
                                        <tr id="row${s2ValueToAdd}">
                                            <td><center>${productSelectedObj.type} ${$(productSelectedObj.name).text()}</center></td>
                                            <td><center>$${productSelectedObj.price}</center></td>
                                            <td>${$('#budgetProductStock').val()}</td>
                                            <td>$${comma_format(parseInt(productSelectedObj.price * $('#budgetProductStock').val()))}</td>
                                            <td>${$('#budgetProductDateOfDelivery').val()}</td>
                                            <td><button onclick="removeBudgetProduct('${s2ValueToAdd}')" id="${s2ValueToAdd}" type="button" class="btn btn-danger btn-xs">x</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                `)
            } else {
                productsAddedToBudget++
                $('#tableBudgetProductsTbody').append(`
                    <tr id="row${s2ValueToAdd}">
                        <td><center>${productSelectedObj.type} ${$(productSelectedObj.name).text()}</center></td>
                        <td><center>$${productSelectedObj.price}</center></td>
                        <td>${$('#budgetProductStock').val()}</td>
                        <td>$${comma_format(parseInt(productSelectedObj.price * $('#budgetProductStock').val()))}</td>
                        <td>${$('#budgetProductDateOfDelivery').val()}</td>
                        <td><button onclick="removeBudgetProduct('${s2ValueToAdd}')" id="${s2ValueToAdd}" type="button" class="btn btn-danger btn-xs">x</button></td>
                    </tr>
                `)
            }
            
            console.log(s2ValueToAdd)
            $(`#selectProductToAdd>option[value="${s2ValueToAdd}"]`).attr('disabled',true).change();
            $('#selectProductToAdd').select2({width:'80%'});

            s2EnabledProducts = s2EnabledProducts.filter(function(item) {
                return item !== s2ValueToAdd
            })
            
            addingProductsArr.push({
                name: $(productSelectedObj.name).text().toLowerCase(),
                type: productSelectedObj.type.toLowerCase(),
                price: parseInt(productSelectedObj.price),
                stock: parseInt($('#budgetProductStock').val()),
                deliveryDate: $('#budgetProductDateOfDelivery').val(),
                identifier: s2ValueToAdd
            })
            finalCalculation()
            console.log(addingProductsArr)

            if(s2EnabledProducts[0]) {
                $('#selectProductToAdd').val('default').trigger('change')
                $('#budgetProductSelected').empty()
            } else {
                $('#selectProductToAdd').val('default').trigger('change')
                $('#addProductToBudget').attr('disabled', true)
                $('#budgetProductSelected').empty()
            }
            
            addingProductStatus = 0
        } else {
            toastr.warning('Debe seleccionar un producto')
        }
    })

    getLayouts().then(res=>{
        if(res) {
            let s2layouts = res.reduce((arr, el, i)=>{
                return arr.concat({
                    id: i,
                    text: el.layoutName
                })
            }, [])

            $('#selectLayout').select2({
                width:'40%',
                data: s2layouts
            })

            $('#selectLayout').on('select2:select', function (e) {
                printLayout()
            });


            getClients().then(clients=>{
                let s2clients = clients.reduce((arr, el, i)=>{
                    return arr.concat({
                        id: el.rut,
                        text: el.name
                    })
                }, [])

                $('#selectClient').select2({
                    width:'80%',
                    data: s2clients
                })

                $('#selectClient').on('select2:select', function (e) {
                    updateClientsHTML()
                });


                updateClientsHTML()
            })

            getProducts().then(products=>{
                let s2products = products.reduce((arr, el, i)=>{
                    s2EnabledProducts.push(`${i}-${el.type.toLowerCase()}`)
                    return arr.concat({
                        id: `${i}-${el.type.toLowerCase()}`,
                        text: $(el.name).text()
                    })
                }, [])

                $('#selectProductToAdd').select2({
                    width:'80%',
                    placeholder: 'Seleccione un producto',
                    data: s2products
                })
                
                $('#selectProductToAdd').on('select2:select', function (e) {
                    let selectProductVal = $('#selectProductToAdd').val()

                    if(selectProductVal != 'default') {
                        addingProductStatus = 1
                    
                        let formatProductType = selectProductVal.substring(selectProductVal.indexOf('-') + 1);
                        let productNameSelected = $('#selectProductToAdd').select2('data')[0].text.toLowerCase()
                        s2ValueToAdd = selectProductVal
                        productSelectedObj = products.filter(function(el) {
                            return $(el.name).text().toLowerCase() == productNameSelected && el.type.toLowerCase() == formatProductType
                        })[0]

                        $('#budgetProductSelected').html(`
                            <div class="row">  
                                <div class="col-md-12 table-responsive">
                                    <div style="background:#ecf0f1;">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <td>Producto</td>
                                                    <td>Precio c/u</td>
                                                    <td>Unidades</td>
                                                    <td>Fecha estimada de entrega</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><br><center>${productSelectedObj.type} <b>${$(productSelectedObj.name).text()}</b></center></td>
                                                    <td><br><center>$${productSelectedObj.price}</center></td>
                                                    <td><input id="budgetProductStock" type="number" value="1" placeholder="Unidades" class="inputColorsPulse form-control border-input justNumbers"></td>
                                                    <td><input id="budgetProductDateOfDelivery" type="text" value="" placeholder="Fecha de entrega" class="inputColorsPulse form-control border-input"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `)

                        $('.justNumbers').keyup(function (){
                            this.value = (this.value + '').replace(/[^0-9]/g, ''); 
                        });

                        getTime().then(time=>{
                            let currentServerTime = time
                            let formatCurrentServerTime = moment(time).format('DD/MM/YYYY') 
                            let defaultExpirationDate = moment(currentServerTime).add(1,'month').format('DD/MM/YYYY')

                            $('#budgetProductDateOfDelivery').val(formatCurrentServerTime)
                            $('#budgetProductDateOfDelivery').daterangepicker({
                                "locale": {
                                    "format": "DD/MM/YYYY",
                                    "daysOfWeek": [
                                    "Dom",
                                    "Lun",
                                    "Mar",
                                    "Mie",
                                    "Jue",
                                    "Vie",
                                    "Sab"
                                    ],
                                    "monthNames": [
                                    "Enero",
                                    "Febrero",
                                    "Marzo",
                                    "Abril",
                                    "Mayo",
                                    "Junio",
                                    "Julio",
                                    "Agosto",
                                    "Septiembre",
                                    "Octubre",
                                    "Noviembre",
                                    "Diciembre"
                                    ],
                                    "firstDay": 1
                                },
                                drops: "up",
                                singleDatePicker: true,
                                showDropdowns: true,
                                minDate: formatCurrentServerTime
                            });
                        })
                    } else {
                        $('#budgetProductSelected').empty()
                    }
                    
                });
            })
            
            getTime().then(time=>{
                let currentServerTime = time
                let formatCurrentServerTime = moment(time).format('DD/MM/YYYY') 
                let defaultExpirationDate = moment(currentServerTime).add(1,'month').format('DD/MM/YYYY')

                $('#serverDate').text(formatCurrentServerTime)
                $('#expirationDate').val(defaultExpirationDate)
                $('#expirationDate').daterangepicker({
                    "locale": {
                        "format": "DD/MM/YYYY",
                        "daysOfWeek": [
                        "Dom",
                        "Lun",
                        "Mar",
                        "Mie",
                        "Jue",
                        "Vie",
                        "Sab"
                        ],
                        "monthNames": [
                        "Enero",
                        "Febrero",
                        "Marzo",
                        "Abril",
                        "Mayo",
                        "Junio",
                        "Julio",
                        "Agosto",
                        "Septiembre",
                        "Octubre",
                        "Noviembre",
                        "Diciembre"
                        ],
                        "firstDay": 1
                    },
                    drops: "up",
                    singleDatePicker: true,
                    showDropdowns: true,
                    minDate: formatCurrentServerTime
                });

            })
              
            printLayout()
        }
   })
}

$('#budgetModal').on('click', '.closeBudgetModal', function(){
    swal({
        title: '¿Estás seguro de cerrar la cotización?',
        text: 'Recuerda que puedes guardar esta cotización como borrador.',
        type: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonClass: 'btn btn-danger',
        cancelButtonClass: 'btn btn-primary',
        buttonsStyling: false,
        confirmButtonText: 'Si, cerrar',
        cancelButtonText: 'No, cancelar',
    }).then((result) => {
        if (result.value) {
            console.log('close')
            $('#budgetModal').modal('hide')
        }
    })
})

$('#budgetModal').on('click', '.closeModal', function(){
    $('#budgetModal').modal('hide')       
})


function updateClientsHTML() {
    
    let selectedClient = $('#selectClient').select2('data')[0].id
    selectedClientData = clientsArr.filter(el=> {
        return el.rut == selectedClient
    })[0]
    
    $('#selectedClientInfo').html(`
    <br>
        <table class="table">
            <tbody>
                <tr>
                    <td><center>Rut</center></td>
                    <td><center><b>${rutFunc(selectedClientData.rut)}</b></center></td>
                </tr>
                <tr>
                    <td><center>Nombre</center></td>
                    <td><center><b>${selectedClientData.name}</b></center></td>
                </tr>
                <tr>
                    <td><center>Teléfono</center></td>
                    <td><center><b>${selectedClientData.phone}</b></center></td>
                </tr>
                <tr>
                    <td><center>Email</center></td>
                    <td><center><b>${selectedClientData.email}</b></center></td>
                </tr>
            </tbody>
        </table>
    `)
    
}

function saveBudget(type, continueDraftId) {
    let status = ''
    let budgetObj = {
        reference: $('#reference').val(),
        creationDate: $('#serverDate').text(),
        expirationDate: $('#expirationDate').val(),
        client: {
            rut: selectedClientData.rut,
            name: selectedClientData.name,
            phone: selectedClientData.phone,
            email: selectedClientData.email
        },
        layout: selectedLayoutData,
        amounts: amounts,
        products: addingProductsArr
    }

    let validateCounter = 0
    let errorMessage = ''
    if(type == 'draft') {
        status = 'draft'
    } else if(type == 'continueDraft') { // en caso de continuar una cotizacion en borrador
        status = 'draft'
        budgetObj.id = continueDraftId
    } else if(type == 'new') {
        status = 'new'
    }

    if (budgetObj.reference.length > 0) { // 1
        validateCounter++
        $('#reference').css({
            border: '1px solid #3498db'
        })
    } else {
        errorMessage += `<br> * Debe ingresar nombre de referencia.`
        $('#reference').css({
            border: '1px solid #e74c3c'
        })
    }

    if(status == 'draft') {
        if(budgetObj.reference.length > 0 && validateCounter > 0) {
            saveDraftBudget(budgetObj)
            $('#errorMessage').empty()
        } else {
            $('#errorMessage').html(`
            <div class="alert alert-dismissible alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                <p class="mb-0">${errorMessage}</p>
            </div> 
            `)
        }
    }
    
    if(status == 'new') {
        if(addingProductsArr.length > 0) { // 2
            validateCounter++
            budgetObj.products = addingProductsArr
            $('#selectProductToAddContainer').css({
                border: '1px solid #3498db'
            })
        } else {
            errorMessage += `<br> * Debe agregar 1 producto como mínimo.`
            $('#selectProductToAddContainer').css({
                border: '1px solid #e74c3c'
            })
        }

        if(selectedClientData.rut && selectedClientData.name && selectedClientData.phone && selectedClientData.email) { // 3
            validateCounter++
            $('#selectedClientInfo').css({
                border: '1px solid #3498db'
            })
        } else {
            errorMessage += `<br> * Debe seleccionar un cliente.`
            $('#selectedClientInfo').css({
                border: '1px solid #e74c3c'
            })
        }


        if(validateCounter == 3) {
            saveNewBudget(budgetObj)
        } else {
            $('#errorMessage').html(`
            <div class="alert alert-dismissible alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4 class="alert-heading">Debe solucionar los siguientes errores:</h4>
                <p class="mb-0">${errorMessage}</p>
            </div> 
            `)
        }
    }
}

function saveNewBudget(budgetObj) {
    console.log(budgetObj)

    ajax({
        url: 'api/newBudget',
        type: 'POST',
        data: {
            reference: budgetObj.reference, // ok
            clientRut: budgetObj.client.rut, // ok
            clientName: budgetObj.client.name, // ok
            clientPhone: budgetObj.client.phone, // ok
            clientEmail: budgetObj.client.email, // ok
            userFirmName: firmObj.name, // ok
            userFirmLastname: firmObj.lastname, // ok
            userFirmPosition: firmObj.position, // ok
            userFirmPhone: firmObj.phone, // ok
            userFirmEmail: firmObj.email, // ok
            products: JSON.stringify(budgetObj.products), // ok
            layout: JSON.stringify(budgetObj.layout), // ok
            creationDate: budgetObj.creationDate, // ok
            expirationDate: budgetObj.expirationDate, // ok
            advancePercent: budgetObj.amounts.advancedPercent.toString(), // ok
            iva: budgetObj.amounts.iva.toString(), // ok
            subtotal: budgetObj.amounts.subtotal.toString() // ok
        }
    }).then(res=>{
        console.log(res)
        if(res.ok) {
            $('#budgetModal').modal('hide')
            toastr.success(`Se ha crado <b>creado y enviado</b> correctamente la cotización con referencia <b>${res.ok.reference}</b> para el cliente <b>${res.ok.client.name}</b>.`)
            
            let formatRes = res.ok 
            formatRes.dateOrder = dateOrder(res.ok._id) // DD/MM/YYYY to YYYYMMDD
            formatRes.reference = res.ok.reference.toUpperCase()
            formatRes.clientName = res.ok.client.name.toUpperCase()
            formatRes.cost = comma_format(parseFloat(res.ok.amounts.iva)+parseFloat(res.ok.amounts.subtotal))
            formatRes.divisa = res.ok.layout.divisa.toUpperCase()
            formatRes.status = formatStatusText(res.ok.status)
            
            let newBudgetAdded = datatable
            .row.add(formatRes)
            .draw()
            .node()
            
            $(newBudgetAdded).css( 'color', '#1abc9c' )
            setTimeout(() => {
                $(newBudgetAdded).css( 'color', '#000000' )
            }, 5000)
        }
    })
}

function saveDraftBudget(budgetObj) {
    console.log(budgetObj)
   
    let continueDraftId = ''
    if(budgetObj.id) {
        continueDraftId = budgetObj.id
    }

    ajax({
        url: 'api/draftBudget',
        type: 'POST',
        data: {
            id: continueDraftId,
            reference: budgetObj.reference, // ok
            clientRut: budgetObj.client.rut, // ok
            clientName: budgetObj.client.name, // ok
            clientPhone: budgetObj.client.phone, // ok
            clientEmail: budgetObj.client.email, // ok
            userFirmName: firmObj.name, // ok
            userFirmLastname: firmObj.lastname, // ok
            userFirmPosition: firmObj.position, // ok
            userFirmPhone: firmObj.phone, // ok
            userFirmEmail: firmObj.email, // ok
            products: JSON.stringify(budgetObj.products), // ok
            layout: JSON.stringify(budgetObj.layout), // ok
            creationDate: budgetObj.creationDate, // ok
            expirationDate: budgetObj.expirationDate, // ok
            advancePercent: budgetObj.amounts.advancedPercent.toString(), // ok
            iva: budgetObj.amounts.iva.toString(), // ok
            subtotal: budgetObj.amounts.subtotal.toString() // ok
        }
    }).then(res=>{
        if(res.ok) {
            let resText = ''
            if(res.ok.status == 'draft' && continueDraftId == '') {
                resText = `Se ha <b>creado</b> correctamente el <b>borrador</b> de cotización con referencia: <b>${res.ok.reference}</b> para el cliente <b>${res.ok.client.name}</b>.`
            } else if(res.ok.status == 'draft' && continueDraftId != '') {
                resText = `Se ha <b>modificado</b> correctamente el <b>borrador</b> de cotización con referencia: <b>${res.ok.reference}</b> para el cliente <b>${res.ok.client.name}</b>.`
                datatable
                .row( rowSelected )
                .remove()
                .draw()
            }

            toastr.success(resText)
            $('#budgetModal').modal('hide')

            let formatRes = res.ok 
            formatRes.dateOrder = dateOrder(res.ok._id) // DD/MM/YYYY to YYYYMMDD
            formatRes.reference = res.ok.reference.toUpperCase()
            formatRes.clientName = res.ok.client.name.toUpperCase()
            formatRes.cost = comma_format(parseFloat(res.ok.amounts.iva)+parseFloat(res.ok.amounts.subtotal))
            formatRes.divisa = res.ok.layout.divisa.toUpperCase()
            formatRes.status = formatStatusText(res.ok.status)
            
            let newBudgetAdded = datatable
            .row.add(formatRes)
            .draw()
            .node();
            
            $(newBudgetAdded).css( 'color', '#2980b9' )
            setTimeout(() => {
                $(newBudgetAdded).css( 'color', '#000000' )
            }, 5000);

        }
    })
    
}

function printLayout() {
    let selectedLayout = $('#selectLayout').select2('data')[0].text
    
    selectedLayoutData = layouts.filter(function(el) {
        return el.layoutName == selectedLayout
    })[0]

    advancePercent = selectedLayoutData.advancePercent
    finalCalculation()
    console.log(advancePercent)
    let generalInfoHTML = selectedLayoutData.generalInfo.reduce((txt, el, i)=>{
        let elReturn = ''
        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
                <p>${el.key}: ${el.value}</p>
            `
        }

        return txt += elReturn
    }, '')
    

    $('#generalInfo').html(`${generalInfoHTML}`)

    $('#importantInfoButton').html(selectedLayoutData.textInfoTitle)
    $('#importantInfo').html(selectedLayoutData.textInfo)

    let checkingAccountHTML = selectedLayoutData.checkingAccount.content.reduce((txt, el, i)=>{
        let elReturn = ''

        if(el.key.length > 0 || el.value.length > 0) {
            elReturn = `
            <tr>
                <td><center>${el.key}</center></td>
                <td><center><b>${el.value}</b></center></td>
            </tr>
            `
        }

        return txt += elReturn
    }, '')


    $('#checkingAccount').html(`
    <div class="card bg-light">
        <div class="card-header"><center>${selectedLayoutData.checkingAccount.title}</center></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <tbody>
                        ${checkingAccountHTML}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `)
    
   console.log(selectedLayoutData)
}

function getLayouts(draftLayout) { // perfecto!
    
    return new Promise(resolve=>{
        ajax({
            url: 'api/layout/getAll'
        }).then(res=> {
            if(res.ok) {
                let resLayouts = res.ok.map(el=>{
                    delete el._id
                    delete el._rev
                    delete el.type

                    return el 
                })
                
                if(draftLayout) {
                    layouts = []
                    draftLayout.layoutName = draftLayout.layoutName + ' (original)'
                    layouts[0] = draftLayout
                    console.log(layouts)
                    layouts = resLayouts.reduce((arr, el, i) =>{
                        return arr.concat(el)
                    }, layouts)
                    
                    console.log(layouts)
                    resolve(layouts)
                } else {
                    layouts = resLayouts
                    resolve(resLayouts)
                }
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }
            
        })
    })
}

function getProducts() {
    return new Promise(resolve=>{
        ajax({
            url: 'api/product/getAll'
        }).then(res=> {
            if(res.ok) {
                products = res.ok

                resolve(res.ok)
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }     
        })
    })
}


function getClients() {
    return new Promise(resolve=> {
        ajax({
            url:'api/clientsEnabled'
        }).then(res=> {
            if(res.ok) {
                clientsArr = res.ok
                resolve(res.ok)
            } else if (res.err) {
                toastr.warning(res.err)
                resolve(null)
            }     
        })
    })
}

function removeBudgetProduct(productToRemove) {
   // $('#tableBudgetProductsTbody')
    $(`[id='row${productToRemove}']`).empty()
    s2EnabledProducts.push(productToRemove)
    $(`#selectProductToAdd>option[value="${productToRemove}"]`).attr('disabled',false).change();
    $('#selectProductToAdd').select2({width:'80%'});
    console.log(s2EnabledProducts)
    productsAddedToBudget--
    $('#addProductToBudget').attr('disabled',false)
    if(productsAddedToBudget == 0) {
        $('#budgetProductsTable').empty()
    }

    addingProductsArr = addingProductsArr.filter(function(item) {
        return item.identifier !== productToRemove
    })
    finalCalculation()

    console.log(addingProductsArr)
            
}

function finalCalculation() {
    let finalAmount = addingProductsArr.reduce((total, el, i)=>{
        return total += el.price * el.stock
    },0)

    let finalAdvance = (finalAmount * advancePercent) / 100
    let finalInDelivery = (finalAmount * (100-advancePercent) ) / 100

    let amountNew = (finalAmount / ((19 / 100) + 1))
    let amountTax = parseFloat(finalAmount) - parseFloat(amountNew)
    let iva
    let amountTXT = ''

    if(selectedLayoutData.divisa == 'clp') {
        iva = parseInt(amountTax)
        amountTXT = 'CLP $'
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp" selected>Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
    } else if (selectedLayoutData.divisa == 'usd') {
        iva = 0
        amountTXT = 'USD $'
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd" selected>Divisa Seleccionada: USD</option>
                <option value="eur">Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
    } else if(selectedLayoutData.divisa == 'eur') {
        iva = 0
        amountTXT = 'EUR €'
        $('#selectedDivisa').html(`
        <div class="form-group">
            <select class="form-control" id="inputSelectDivisa">
                <option value="clp">Divisa Seleccionada: CLP </option>
                <option value="usd">Divisa Seleccionada: USD</option>
                <option value="eur" selected>Divisa Seleccionada: EUR </option>
            </select>
        </div>
        `)
    }

    $('#inputSelectDivisa').on('change', function() {
        if($(this).val() == 'clp') {
            selectedLayoutData.divisa = 'clp'
        } else if($(this).val() == 'usd') {
            selectedLayoutData.divisa = 'usd'
        } else if($(this).val() == 'eur') {
            selectedLayoutData.divisa = 'eur'
        }

        finalCalculation()
    })
    

    console.log(amountNew, amountTax, iva)

    amounts.advancedPercent = advancePercent
    amounts.finalAdvance = finalAdvance
    amounts.iva = iva
    amounts.subtotal = finalAmount

    $('#finalCalculations').html(`
        <h3><b>Condiciones comerciales, de pago y Facturación:</b></h3>
        <table class="table table-hover">
            <tbody>
                <tr>
                    <td><center>${advancePercent}% de anticipo de reserva:</center></td>
                    <td><center><b>${amountTXT}${comma_format(finalAdvance)}</b></center></td>
                </tr>
                <tr>
                    <td><center>${100-advancePercent}% Saldo, al momento del despacho de las plantas:</center></td>
                    <td><center><b>${amountTXT}${comma_format(finalInDelivery)}</b></center></td>
                </tr>
                <tr>
                    <td><center>IVA, se deberá cancelar documentado, al día 10 del mes siguiente de la fecha de despacho:</center></td>
                    <td><center><b>${amountTXT}${comma_format(iva)}</b></center></td>
                </tr>
                <tr>
                    <td><center>Sub total:</center></td>
                    <td><center><b>${amountTXT}${comma_format(finalAmount)}</b></center></td>
                </tr>
                <tr>
                    <td><center><h3>Total a pagar:</h3></center></td>
                    <td><center><h3 style="color:#1abc9c;"><b>${amountTXT}${comma_format(finalAmount+iva)}</b></h3></center></td>
                </tr>
            </tbody>
        </table>
    `)
}

function chargeFirm(draftFirm) {
    if(draftFirm) {
        firmObj = {
            name: draftFirm.name,
            lastname: draftFirm.lastname,
            position: draftFirm.position,
            phone: draftFirm.phone,
            email: draftFirm.email
        }
        console.log(firmObj)

        $('#firm').html(`
            <center>
                <p style="font-family:Lucida Calligraphy; font-size:20px; color:#2ecc71; margin:1px">${capitalizeAll(firmObj.name)} ${capitalizeAll(firmObj.lastname)}.</p>
                <p style="font-family:Arial; margin:1px; font-size:18px;">AGROMILLORA SUR S.A.</p>
                <p style="margin:1px; font-size:18px;">${capitalizeAll(firmObj.position)}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.email}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.phone}</p>
            </center>
        `)
    } else {
        firmObj = {
            name: '{{credentials.name}}',
            lastname: '{{credentials.lastname}}',
            position: '{{credentials.position}}',
            phone: '{{credentials.phone}}',
            email: '{{credentials.email}}'
        }
        console.log(firmObj)

        $('#firm').html(`
            <center>
                <p style="font-family:Lucida Calligraphy; font-size:20px; color:#2ecc71; margin:1px">${capitalizeAll(firmObj.name)} ${capitalizeAll(firmObj.lastname)}.</p>
                <p style="font-family:Arial; margin:1px; font-size:18px;">AGROMILLORA SUR S.A.</p>
                <p style="margin:1px; font-size:18px;">${capitalizeAll(firmObj.position)}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.email}</p>
                <p style="margin:1px; font-size:18px;">${firmObj.phone}</p>
            </center>
        `)
    }

    
}
</script>
{{/extend}}
