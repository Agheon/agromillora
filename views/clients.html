{{!< layout/default}}

{{#extend "css"}}
<style>
    #tableClients tbody tr {
        cursor: pointer;
    }
</style>
{{/extend}}
<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-pills mb-3 nav-justified" id="pills-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pills-clients-tab" data-toggle="pill" href="#pills-clients" role="tab" aria-controls="pills-home" aria-selected="true">Clientes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-disabledClients-tab" data-toggle="pill" href="#pills-disabledClients" role="tab" aria-controls="pills-profile" aria-selected="false">Clientes deshabilitados</a>
            </li>
        </ul>
    </div>

    <div class="col-md-12">
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-clients" role="tabpanel" aria-labelledby="pills-clients-tab">
                <div class="row">
                    <div class="col-md-2 col-xs-12">
                        <br>
                        <button class="btn btn-dark btn-block btnSecond" id="optionCreateClient">
                            <i style="color:#3498db;" class="fas fa-plus"></i> Nuevo cliente
                        </button>
                        <!--
                        <button class="btn btn-dark btn-block btnSecond" id="optionTypeClient">
                            <i style="color:#1abc9c;" class="fas fa-list-ul"></i> Tipos de clientes
                        </button>
                        -->
                        <hr>
                        <button class="btn btn-dark btn-block btnSecond2" id="optionModClient" disabled>
                            <i style="color:#f1c40f;" class="fas fa-edit"></i> Modificar cliente
                        </button>
                        <button class="btn btn-dark btn-block btnSecond2" id="optionDisableClient" disabled>
                            <i style="color:#e74c3c;" class="fas fa-ban"></i> Deshabilitar cliente
                        </button>
                    </div>
                
                    <div class="col-md-10 col-xs-12 box-shadows table-responsive">
                        <table id="tableClients" class="display nowrap table table-condensed" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Rut</th>
                                    <th>Nombre</th>
                                    <th>Teléfono</th>
                                    <th>Email</th>
                                </tr>
                            </thead>
                        </table>
                        <div id="loadingClients">
                            <center>
                                <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>
                                <span class="sr-only">Cargando...</span>
                            </center>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-disabledClients" role="tabpanel" aria-labelledby="pills-disabledClients-tab">
                <div class="row">
                    <div class="col-md-2 col-xs-12">
                        <br>
                        <button class="btn btn-dark btn-block btnSecond2" id="optionEnableClient" disabled>
                            <i style="color:#3498db;" class="fas fa-check"></i> Habilitar cliente
                        </button>
                        <button class="btn btn-dark btn-block btnSecond2" id="optionDeleteClient" disabled>
                            <i style="color:#e74c3c;" class="fas fa-times"></i> Eliminar cliente
                        </button>
                    </div>
                    
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" role="dialog" aria-labelledby="modal_title">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modal_title"></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal_body"></div>
            <div class="modal-footer" id="modal_footer"></div>
        </div>
    </div>
</div>

{{#extend "js"}}
<script>
let datatableClients
let datatableDisabledClients
let clientRowSelected
let clientRowSelectedData

$(document).ready(function(){
    chargeClientsTable()
})

function chargeClientsTable() {
    datatableClients = $('#tableClients')
    .DataTable( {
        ordering: true,
        iDisplayLength: 50,
        oLanguage: {
            sSearch: 'buscar: '
        },
        responsive: false,
        columns: [
            { data: 'rut' },
            { data: 'name' },
            { data: 'phone' },
            { data: 'email' }                
        ],
        initComplete: function (settings, json) {
            ajax({
                url: 'api/clientsEnabled'
            }).then(res => {
                if (res.err) {
                    toastr.warning(res.err)
                    $('#loadingClients').empty()
                } else if(res.ok) {
                    let formatRes = res.ok.map(el=>{
                        el.rut = `<b>${rutFunc(el.rut)}</b>`    
                        return el
                    })

                    datatableClients.rows.add(formatRes).draw()
                    $('#loadingClients').empty()
                }      
            })
        }
    })


    $('#tableClients tbody').on('click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected')
            $('#optionModClient').prop('disabled', true)
            $('#optionDisableClient').prop('disabled', true)
        } else {
            datatableClients.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            $('#optionModClient').prop('disabled', false)
            $('#optionDisableClient').prop('disabled', false)
            clientRowSelectedData = cleanData(datatableClients.row($(this)).data())
            clientRowSelected = datatableClients.row($(this))
        }
    })
}

function cleanData(data){
    data.rut = ktoK($(cleanRut(data.rut)).text())

    return data
}

$('#optionCreateClient').on('click', function() { // CREAR CLIENTE

    $('#clientModal').modal('show');
    $('#modal_title').html(`Nuevo cliente`)
    $('#modal_body').html(`   
        <div class="row">
            <div class="col-md-4" style="margin-top:10px;">
                Rut del cliente
                <input id="newClientRut" type="text" placeholder="Rut del cliente" class="form-control border-input">
            </div>
            
            <div class="col-md-4" style="margin-top:10px;">
                Nombre del cliente
                <input id="newClientName" type="text" placeholder="Nombre del cliente" class="form-control border-input">
            </div>

            <div class="col-md-4" style="margin-top:10px;">
                Teléfono
                <input id="newClientPhone" type="text" placeholder="Teléfono del cliente" class="form-control border-input">
            </div>

            <div class="col-md-4" style="margin-top:10px;">
                Email
                <input id="newClientEmail" type="text" placeholder="Email del cliente" class="form-control border-input">
            </div>

            <div class="col-md-12" id="newClientErrorMessage"></div>
        </div>   
    `)

    $('#modal_footer').html(`
        <button class="btn btn-dark" data-dismiss="modal">
            <i style="color:#e74c3c;" class="fas fa-times"></i> Cancelar
        </button>

        <button class="btn btn-dark" id="saveClient">
            <i style="color:#3498db;" class="fas fa-check"></i> Guardar
        </button>
    `)

    setTimeout(() => {
        $('#newClientRut').focus()    
    }, 500)

    $('#saveClient').on('click', function(){
        let clientData = {
            rut: $('#newClientRut').val(),
            name: $('#newClientName').val(),
            phone: $('#newClientPhone').val(),
            email: $('#newClientEmail').val()
        }
        
        
        ajax({
            url: 'api/client',
            type: 'POST',
            data: {
                rut:clientData.rut,
                name:clientData.name,
                phone:clientData.phone,
                email:clientData.email
            }
        }).then(res=>{
            if(res.err) {
                toastr.warning(res.err)
            } else if(res.ok) {
                toastr.success('Cliente creado correctamente')
                
                res.ok.rut = `<b>${rutFunc(res.ok.rut)}</b>`

                let newClientAdded = datatableClients
                .row.add(res.ok)
                .draw()
                .node();
                
                $(newClientAdded).css( 'color', '#1abc9c' )
                setTimeout(() => {
                    $(newClientAdded).css( 'color', '#484848' )
                }, 5000);

                $('#clientModal').modal('hide')
            }
        })
    })
})

$('#optionModClient').on('click', function() { // CREAR CLIENTE

    $('#clientModal').modal('show');
    $('#modal_title').html(`modificar cliente: ${capitalizeAll(clientRowSelectedData.name)}`)
    $('#modal_body').html(`   
        <div class="row">
            <div class="col-md-4" style="margin-top:10px;">
                Rut del cliente
                <input value="${rutFunc(clientRowSelectedData.rut)}" id="newClientRut" type="text" placeholder="Rut del cliente" class="form-control border-input">
            </div>
            
            <div class="col-md-4" style="margin-top:10px;">
                Nombre del cliente
                <input value="${clientRowSelectedData.name}" id="newClientName" type="text" placeholder="Nombre del cliente" class="form-control border-input">
            </div>

            <div class="col-md-4" style="margin-top:10px;">
                Teléfono
                <input value="${clientRowSelectedData.phone}" id="newClientPhone" type="text" placeholder="Teléfono del cliente" class="form-control border-input">
            </div>

            <div class="col-md-4" style="margin-top:10px;">
                Email
                <input value="${clientRowSelectedData.email}" id="newClientEmail" type="text" placeholder="Email del cliente" class="form-control border-input">
            </div>

            <div class="col-md-12" id="newClientErrorMessage"></div>
        </div>   
    `)

    $('#modal_footer').html(`
        <button class="btn btn-dark" data-dismiss="modal">
            <i style="color:#e74c3c;" class="fas fa-times"></i> Cancelar
        </button>

        <button class="btn btn-dark" id="saveClient">
            <i style="color:#3498db;" class="fas fa-check"></i> Guardar
        </button>
    `)

    setTimeout(() => {
        $('#newClientRut').focus()    
    }, 500)

    $('#saveClient').on('click', function(){
        let clientData = {
            rut: $('#newClientRut').val(),
            name: $('#newClientName').val(),
            phone: $('#newClientPhone').val(),
            email: $('#newClientEmail').val()
        }
        
        swal({
            title: `¿Estás seguro de modificar el cliente?`,
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonClass: 'btn btn-primary',
            cancelButtonClass: 'btn btn-danger',
            buttonsStyling: false,
            confirmButtonText: 'Si, modificar',
            cancelButtonText: 'No, cancelar',
        }).then((result) => {
            if (result.value) {
                ajax({
                    url: 'api/client',
                    type: 'PUT',
                    data: {
                        originalRut:clientRowSelectedData.rut,
                        rut:clientData.rut,
                        name:clientData.name,
                        phone:clientData.phone,
                        email:clientData.email
                    }
                }).then(res=>{
                    if(res.err) {
                        toastr.warning(res.err)
                    } else if(res.ok) {
                        toastr.success('Cliente modificado correctamente')
                        res.ok.rut = `<b>${rutFunc(res.ok.rut)}</b>`
                        
                        datatableClients
                        .row( clientRowSelected )
                        .remove()
                        .draw()

                        let newClientAdded = datatableClients
                        .row.add(res.ok)
                        .draw()
                        .node();
                        
                        $(newClientAdded).css( 'color', '#1abc9c' )
                        setTimeout(() => {
                            $(newClientAdded).css( 'color', '#484848' )
                        }, 5000);

                        $('#clientModal').modal('hide')
                    }
                })
            }
        })
        
    })
})
</script>
{{/extend}}