{{!< layout/default}}

{{#extend "css"}}

{{/extend}}

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12">
        <div class="accordion" id="accordionAvailability">
            <div class="card">
                <div class="card-header" id="headingFilter">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseFilter" aria-expanded="true" aria-controls="collapseFilter">
                            Filtrar Productos
                        </button>
                    </h5>
                </div>
            
                <div id="collapseFilter" class="collapse show" aria-labelledby="headingFilter" data-parent="#accordionAvailability">
                    <div class="card">
                        <!--<h3 class="card-header">Filtrar productos</h3>-->
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label>Area</label>
                                                <select id="areaFilter" class="custom-select">
                                                    <option values="placeholder" readOnly>-- TODAS LAS AREAS --</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div class="row">
                                        <div class="col-9">
                                            <div class="form-group">
                                                <label>Producto</label>
                                                <select style="width:100%;" id="variedadesFilter" name="productos[]" multiple="multiple"></select>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-group">
                                                <br>
                                                <br>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="allVariedades" checked>
                                                    <label class="custom-control-label" for="allVariedades">Todos</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div class="row">
                                        <div class="col-9">
                                            <div class="form-group">
                                                <label>Envase</label>
                                                <select style="width:100%;" id="envaseFilter" name="envases[]" multiple="multiple"></select>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-group">
                                                <br>
                                                <br>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="allEnvases" checked>
                                                    <label class="custom-control-label" for="allEnvases">Todos</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-9">
                                            <div class="form-group">
                                                <label>Tipo bodega</label>
                                                <select style="width:100%;" id="tipobodegaFilter" name="tipobodegas[]" multiple="multiple"></select>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-group">
                                                <br>
                                                <br>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="allTipobodegas" checked>
                                                    <label class="custom-control-label" for="allTipobodegas">Todos</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-9">
                                            <div class="form-group">
                                                <label>Almacen</label>
                                                <select style="width:100%;" id="almacenFilter" name="almacen[]" multiple="multiple"></select>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-group">
                                                <br>
                                                <br>
                                                <div class="custom-control custom-checkbox">
                                                    <input type="checkbox" class="custom-control-input" id="allAlmacenes" checked>
                                                    <label class="custom-control-label" for="allAlmacenes">Todos</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!--
                            <div class="row">
                                <div class="col-10">
                                    <label>Fecha estimada de DESPACHO</label>
                                    <input id="productDateDelivery" type="text" value="" placeholder="Fecha de entrega" class="form-control border-input">
                                </div>
                                <div class="col-2"></div>
                            </div>
                            -->
                            <br>
                            <div class="row">
                                <div class="col-2"></div>
                                <div class="col-8">
                                    <button class="btn btn-primary btn-block" id="searchBtn" disabled>
                                        BUSCAR PRODUCTOS <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="col-2" id="loadingSearch"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-header" id="headingResults">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseResults" aria-expanded="true" aria-controls="collapseResults">
                            Resultados de busqueda <span id="searchResultsCount"><span class="badge badge-secondary">0</span></span>
                        </button>
                    </h5>
                </div>

                <div id="collapseResults" class="collapse" aria-labelledby="headingFilter" data-parent="#accordionAvailability"></div>

            </div>
        </div>
    </div>
         
</div>

{{#extend "js"}}
<script>
let allProducts = []
let fromInvoiceArr = []

$(document).ready(function(){

    //$('#budgetProductDateOfDelivery').val(formatCurrentServerTime)
    /*
    $('#productDateDelivery').daterangepicker({
        "locale": {
            "format": "DD/MM/YYYY",
            "daysOfWeek": [
            "Dom",
            "Lun",
            "Mar",
            "Mie",
            "Jue",
            "Vie",
            "Sab"
            ],
            "monthNames": [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre"
            ],
            "firstDay": 1
        },
        drops: "up",
        singleDatePicker: true,
        showDropdowns: true,
        //minDate: formatCurrentServerTime
    })
    */

    getAllProducts().then(res=>{
        
        /* INICIO AREAS */
        let areasNoRepeat = []
        let areas = res.ok.reduce((txt, el, i)=>{
            let actualArea
            if(areasNoRepeat.indexOf(el.area) === -1 && el.area != null) {
                areasNoRepeat.push(el.area)
                actualArea = `
                <option value="${el.area}">
                    ${el.area}
                </option>
                ` 
            }

            return txt += actualArea
        }, '')

        /* FIN AREAS */
        
        /* INICIO VARIEDADES */
        let variedadNoRepeat = []
        let variedades = res.ok.reduce((arr, el, i)=>{
            let actualVariedad
            if(variedadNoRepeat.indexOf(el.variedad) === -1 && el.variedad != null) {
                variedadNoRepeat.push(el.variedad)
                actualVariedad = {
                    id: el.variedad,
                    text: el.variedad
                }
            }

            return arr.concat(actualVariedad)
        }, [])
        
        let variedadesClean = variedades.filter(el=>{
            return typeof el !== 'undefined'
        })

        variedadesClean = variedadesClean.sort(function(a, b) {
            return a.text.toLowerCase().localeCompare(b.text.toLowerCase());
        })

        /* FIN VARIEDADES */
        
        /* INICIO ENVASES */
        let envaseNoRepeat = []
        let envases = res.ok.reduce((arr, el, i)=>{
            let actualEnvase
            if(envaseNoRepeat.indexOf(el.soloEnvase) === -1 && el.soloEnvase != null) {
                envaseNoRepeat.push(el.soloEnvase)
                actualEnvase = {
                    id: el.soloEnvase,
                    text: el.soloEnvase
                }
            }

            return arr.concat(actualEnvase)
        }, [])
        
        let envasesClean = envases.filter(el=>{
            return typeof el !== 'undefined'
        })

        envasesClean = envasesClean.sort(function(a, b) {
            return a.text.toLowerCase().localeCompare(b.text.toLowerCase());
        })

        /* FIN ENVASES*/

        /* INICIO TIPO BODEGAS */
        let tipobodegaNoRepeat = []
        let tipobodegas = res.ok.reduce((arr, el, i)=>{
            let actualTipobodega
            if(tipobodegaNoRepeat.indexOf(el.tipobodega) === -1 && el.tipobodega != null) {
                tipobodegaNoRepeat.push(el.tipobodega)
                actualTipobodega = {
                    id: el.tipobodega,
                    text: el.tipobodega
                }
            }

            return arr.concat(actualTipobodega)
        }, [])
        
        let tipobodegaClean = tipobodegas.filter(el=>{
            return typeof el !== 'undefined'
        })
        
        
        tipobodegaClean = tipobodegaClean.sort(function(a, b) {
            return a.text.toLowerCase().localeCompare(b.text.toLowerCase());
        })
    
        /* FIN TIPO BODEGAS */

        /* INICIO ALMACEN */
        let almacenNoRepeat = []
        let almacenes = res.ok.reduce((arr, el, i)=>{
            let actualAlmacen
            if(almacenNoRepeat.indexOf(el.almacen) === -1 && el.almacen != null) {
                almacenNoRepeat.push(el.almacen)
                actualAlmacen = {
                    id: el.almacen,
                    text: el.almacen
                }
            }

            return arr.concat(actualAlmacen)
        }, [])
        
        let almacenClean = almacenes.filter(el=>{
            return typeof el !== 'undefined'
        })
        
        almacenClean = almacenClean.sort(function(a, b) {
            return a.text.toLowerCase().localeCompare(b.text.toLowerCase());
        })
    
        /* FIN ALMACEN */

        $('#areaFilter').append(areas) // cargar areas
        
        //console.log(variedadesClean)
        $('#variedadesFilter').select2({ // variedades
            data: variedadesClean
        })
        
        //console.log(envasesClean)
        $('#envaseFilter').select2({ // envases
            data: envasesClean
        })

        $('#tipobodegaFilter').select2({ // tipobodegas
            data: tipobodegaClean
        })

        $('#almacenFilter').select2({ // almacen
            data: almacenClean
        })
        
        $('#searchBtn').attr('disabled', false)
        selectAllEnvases()
        selectAllVariedades()
        selectAllTipobodegas()
        selectAllAlmacenes()

    })
    
})

function getAllProducts() {
    return new Promise(resolve=> {
        ajax({
            url:'/api/products/getAllProducts',
        }).then(res=>{
            if(res.ok) {
                allProducts = res.ok.list
                resolve({ok:res.ok.list})
            } else if(res.err) {
                toastr.warning('No se encuentran productos')
                resolve()
            }
        })
    })
}

/*  INICIO SELECT ALL*/
function selectAllEnvases() {
    if($('#allEnvases').is(':checked') ){
        $('#envaseFilter').attr('disabled', true)
        $('#envaseFilter > option').prop('selected','selected');
        $('#envaseFilter').trigger('change');
    } else {
        $('#envaseFilter').attr('disabled', false)
        $('#envaseFilter > option').removeAttr('selected');
        $('#envaseFilter').trigger('change');
    }
}

function selectAllVariedades() {
    if($('#allVariedades').is(':checked') ){
        $('#variedadesFilter').attr('disabled', true)
        $('#variedadesFilter > option').prop('selected','selected');
        $('#variedadesFilter').trigger('change');
    } else {
        $('#variedadesFilter').attr('disabled', false)
        $('#variedadesFilter > option').removeAttr('selected');
        $('#variedadesFilter').trigger('change');
    }
}

function selectAllTipobodegas() {
    if($('#allTipobodegas').is(':checked') ){
        console.log('checked')
        $('#tipobodegaFilter').attr('disabled', true)
        $('#tipobodegaFilter > option').prop('selected','selected');
        $('#tipobodegaFilter').trigger('change');
    } else {
        console.log('unchec...')
        $('#tipobodegaFilter').attr('disabled', false)
        $('#tipobodegaFilter > option').removeAttr('selected');
        $('#tipobodegaFilter').trigger('change');
    }
}

function selectAllAlmacenes() {
    if($('#allAlmacenes').is(':checked') ){
        $('#almacenFilter').attr('disabled', true)
        $('#almacenFilter > option').prop('selected','selected');
        $('#almacenFilter').trigger('change');
    } else {
        $('#almacenFilter').attr('disabled', false)
        $('#almacenFilter > option').removeAttr('selected');
        $('#almacenFilter').trigger('change');
    }
}

/* FIN SELECT ALL */

function searchProducts() {
    return new Promise(resolve=>{
        let filterAreaVal = $('#areaFilter').val()
        let filterProductVal = $('#variedadesFilter').val()
        let filterEnvaseVal = $('#envaseFilter').val()
        let filterTipobodegaVal = $('#tipobodegaFilter').val()
        let filterAlmacenVal = $('#almacenFilter').val()
        
        console.log({
            areas: filterAreaVal,
            products: filterProductVal,
            envases: filterEnvaseVal,
            tipobodegas: filterTipobodegaVal,
            almacen: filterAlmacenVal
        })
        
        if(!filterProductVal || !filterEnvaseVal || !filterTipobodegaVal || !filterAlmacenVal) {
            resolve({err: 'Debe seleccionar al menos <b>1 Producto, 1 Envase, 1 tipo de bodega y 1 almacén</b>'})
        } else {
            filterStep1(filterAreaVal).then(res1=>{ 
                filterStep2(res1, filterProductVal).then(res2=>{ 
                    filterStep3(res2, filterEnvaseVal).then(res3=>{
                        filterStep4(res3, filterTipobodegaVal).then(res4=>{
                            filterStep5(res4, filterAlmacenVal).then(res5=>{
                                //console.log(res5)
                                if(res5.length == 0) {
                                    resolve({err: 'No se han encontrado productos en base a los filtros seleccionados'})
                                } else {
                                    let sumGroup = []
                                    res5.reduce(function (res, value) {
                                        if (!res[value.variedad]) {
                                            res[value.variedad] = {
                                                stock: 0,
                                                variedad: value.variedad
                                            }
                                            sumGroup.push(res[value.variedad])
                                        }
                                        
                                        res[value.variedad].stock += parseInt(value.stockactual)
                                        
                                        return res
                                    }, {})

                                    resolve({ok: {group:sumGroup, original:res5}})
                                }
                            })
                        })
                    })
                    
                })
                
            })
        }

    })
}

function filterStep1(filterAreaVal) { // areas
    return new Promise(resolve=>{
        if(filterAreaVal !== '-- TODAS LAS AREAS --') {
            let filterStep1 = allProducts.filter(el=>{
                return el.area == filterAreaVal
            })

            resolve(filterStep1)
        } else {
            resolve(allProducts)
        }
    })
}

function filterStep2(products, filterProductVal) { // productos
    return new Promise(resolve=>{
        let reduceStep2 = filterProductVal.reduce((arr, elReduce, i) => {
            let filterStep2 = products.filter(el=>{
                return el.variedad == elReduce
            })

            return arr.concat(filterStep2)
        }, [])
 
        resolve(reduceStep2)
    })
}

function filterStep3(products, filterEnvaseVal) { // envases
    return new Promise(resolve=>{
        let reduceStep3 = filterEnvaseVal.reduce((arr, elReduce, i) => {
            let filterStep3 = products.filter(el=>{
                return el.soloEnvase == elReduce
            })

            return arr.concat(filterStep3)
        }, [])

        
        resolve(reduceStep3)
    })
}

function filterStep4(products, filterTipobodegaVal) { // tipobodega
    return new Promise(resolve=>{
        let reduceStep4 = filterTipobodegaVal.reduce((arr, elReduce, i) => {
            let filterStep4 = products.filter(el=>{
                return el.tipobodega == elReduce
            })

            return arr.concat(filterStep4)
        }, [])

        
        resolve(reduceStep4)
    })
}

function filterStep5(products, filterAlmacenVal) { // almacen
    return new Promise(resolve=>{
        let reduceStep5 = filterAlmacenVal.reduce((arr, elReduce, i) => {
            let filterStep5 = products.filter(el=>{
                return el.almacen == elReduce
            })

            return arr.concat(filterStep5)
        }, [])

        
        resolve(reduceStep5)
    })
}

$('#allEnvases').on('change', function(){
    selectAllEnvases()
})

$('#allVariedades').on('change', function(){
    selectAllVariedades()
})

$('#allTipobodegas').on('change', function(){
    selectAllTipobodegas()
})

$('#allAlmacenes').on('change', function(){
    selectAllAlmacenes()
})

$('#searchBtn').on('click', function(){
    $(this).attr('disabled', true)
    $('#loadingSearch').html(`
        <center>
            <i style="color:#3498db;" class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
            <span class="sr-only">Cargando...</span>
        </center>
    `)

    searchProducts().then(res=>{
        if(res.ok) {
            $('#searchBtn').attr('disabled', false)
            $('#loadingSearch').empty()
            console.log(res.ok)
            chargeResults(res.ok)
            //$('#collapseFilter').collapse('hide')
            $('#collapseResults').collapse('show')
        } else if(res.err) {
            $('#searchBtn').attr('disabled', false)
            $('#loadingSearch').empty()
            toastr.warning(res.err)
            cleanResults()
        }
    })
})

function removeSpecials(data) {
    data = data.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '');
    data = data.replace(/\s/g,'')
    return data
}

function chargeResults(products) { /* TODO: ordenar arreglo con lodash */
    $('#searchResultsCount').html(`<span class="badge badge-primary">${products.original.length}</span>`)

    let productsHTML = products.original.reduce((txt,el,i)=>{
        return txt += `
            <tr>
                <td>
                    ${el.variedad}
                </td>
                <td>
                    ${el.envase}
                </td>
                <td>
                    ${el.tipobodega}
                </td>
                <td>
                    ${el.almacen}
                </td>
                <td>
                    ${el.stockactual}
                </td>
            </tr>
        `
    }, '')

    let areaSelected = ''

    if($(areaFilter).val() == '-- TODAS LAS AREAS --') {
       areaSelected = 'TODAS LAS AREAS'
    } else {
        areaSelected = $(areaFilter).val()
    }
    
    let envasesSelected = $('#envaseFilter').val().reduce((txt, el, i)=>{
        return txt += ` ${el},`
    }, '')

    let tipobodegaSelected = $('#tipobodegaFilter').val().reduce((txt, el, i)=>{
        return txt += ` ${el},`
    }, '')

    let almacenesSelected = $('#almacenFilter').val().reduce((txt, el, i)=>{
        let finalCommaOrPoint = ''
        if(i+1 === $('#almacenFilter').val().length) {
            finalCommaOrPoint = ` ${el}.`
        } else {
            finalCommaOrPoint = ` ${el},`
        }
        return txt += finalCommaOrPoint
    }, '')

    $('#collapseResults').html(`
        <div class="alert alert-dismissible alert-primary">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            Los siguientes <b>${products.original.length}</b> productos corresponden a los filtros de area <b>${areaSelected}</b>, envase <b>${envasesSelected}</b> tipo de bodega <b>${tipobodegaSelected}</b> y almacen <b>${almacenesSelected}</b>
        </div>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">PRODUCTO</th>
                    <th scope="col">ENVASE/TAMAÑO</th>
                    <th scope="col">TIPO BODEGA</th>
                    <th scope="col">ALMACEN</th>
                    <th scope="col">CANTIDAD</th>
                </tr>
            </thead>
            <tbody>
                ${productsHTML}
            </tbody>
        </table>

        <div class="row">
            <div class="col-md-6">
                <div id="containerBar"></div>
            </div>
        </div>
    `)

    $('.btnSendToInvoice').on('click', function(){
        let productId = $(this).attr('id')
        console.log(productId)
        let sendProductSelected = products.filter(el => {
            return `toinvoice-${removeSpecials(el.variedad)}` == productId
        })[0]

        if($(`#${productId}`).hasClass('btn-primary')) {
            if(fromInvoiceArr.length < 10) {
                $(`#${productId}`).removeClass('btn-primary')
                $(`#${productId}`).addClass('btn-danger')
                $(`#${productId}`).html('<i class="fas fa-arrow-circle-left"></i>')
                addToInvoice(sendProductSelected)
            } else {
                toastr.warning('10 productos máximo')
            }
            

        } else if($(`#${productId}`).hasClass('btn-danger')) {
            $(`#${productId}`).removeClass('btn-danger')
            $(`#${productId}`).addClass('btn-primary')
            $(`#${productId}`).html('<i class="fas fa-arrow-circle-right"></i>')
            
            removeFromInvoice(sendProductSelected)
        }

    })
}

/*
function addToInvoice(product) {
    fromInvoiceArr.push(product.variedad)
    if(fromInvoiceArr.length > 0) {
        $('#emptyMessageOrSaveCart').html(`
            <button type="button" class="btn btn-primary btn-block">GUARDAR CARRITO CON ${fromInvoiceArr.length} PRODUCTOS <i class="fas fa-shopping-cart"></i></button>
        `)
    }

    console.log(fromInvoiceArr)
    $('#toInvoiceBody').append(`
        <tr id="frominvoicerow-${removeSpecials(product.variedad)}">
            <td>
                <button type="button" class="btn btn-danger btn-sm btnRemoveFromInvoice" id="frominvoice-${removeSpecials(product.variedad)}"><i class="fas fa-arrow-circle-left"></i></button>
            </td>
            <td>
                ${product.variedad}
            </td>
            <td>
                ${product.stock}
            </td>
            <td>
                <div class="form-group">
                    <input class="form-control justNumbers" type="text" placeholder="Cantidad a cotizar">
                </div>
            </td>
        </tr>
    `)

    $(`#frominvoice-${removeSpecials(product.variedad)}`).on('click', function() {
        removeFromInvoice(product)
        if($(`#toinvoice-${removeSpecials(product.variedad)}`).hasClass('btn-danger')) {
            $(`#toinvoice-${removeSpecials(product.variedad)}`).removeClass('btn-danger')
            $(`#toinvoice-${removeSpecials(product.variedad)}`).addClass('btn-primary')
            $(`#toinvoice-${removeSpecials(product.variedad)}`).html('<i class="fas fa-arrow-circle-right"></i>')
        }
    })
}

function removeFromInvoice(product) {
    $(`#frominvoicerow-${removeSpecials(product.variedad)}`).remove()
    fromInvoiceArr = fromInvoiceArr.filter(e => e !== product.variedad)
    if(fromInvoiceArr.length == 0) {
        $('#emptyMessageOrSaveCart').html(`
            <div class="alert alert-dismissible alert-primary">
                <h3>Sin productos a cotizar</h3>
                <p>Agregue productos para añadir a una cotización</p>
            </div>
        `)
    } else {
        $('#emptyMessageOrSaveCart').html(`
            <button type="button" class="btn btn-primary btn-block">GUARDAR CARRITO CON ${fromInvoiceArr.length} PRODUCTOS <i class="fas fa-shopping-cart"></i></button>
        `)
    }
    console.log(fromInvoiceArr)
}

*/

function cleanResults() {
    $('#searchResultsCount').html('<span class="badge badge-secondary">0</span>')
    $('#collapseResults').empty()
}

</script>
{{/extend}}